
================================================================================
–ú–û–ù–û–õ–ò–¢–ù–´–ô –≠–ö–°–ü–û–†–¢ –ü–†–û–ï–ö–¢–ê: python_trading
================================================================================

üìÖ –î–∞—Ç–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: 2025-12-11 21:58:01
üìÅ –ö–æ—Ä–Ω–µ–≤–∞—è –ø–∞–ø–∫–∞: /Users/vladimirbasov/Desktop/python_trading
üë§ –≠–∫—Å–ø–æ—Ä—Ç—ë—Ä: MonolithicProjectExporter v1.0

================================================================================
–ü–†–ò–ú–ï–ß–ê–ù–ò–Ø:
1. –§–∞–π–ª—ã —Ä–∞–∑–¥–µ–ª–µ–Ω—ã –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ —Å '======'
2. –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (—Ç–æ–∫–µ–Ω—ã, –∫–ª—é—á–∏) –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ [SECRET_REMOVED]
3. –ë–∏–Ω–∞—Ä–Ω—ã–µ —Ñ–∞–π–ª—ã –ø—Ä–æ–ø—É—â–µ–Ω—ã, —Ç–æ–ª—å–∫–æ –∏—Ö –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
4. –í—Å–µ –ø—É—Ç–∏ —É–∫–∞–∑–∞–Ω—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞
================================================================================



================================================================================
–§–ê–ô–õ: .env
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/.env
================================================================================

# Tinkoff Invest API
INVEST_TOKEN=[SECRET_REMOVED]

# –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã (sandbox –∏–ª–∏ real)
SANDBOX=true

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –¢–ì –±–æ—Ç–∞ - @trading_monitor_VB_bot
TELEGRAM_BOT_TOKEN=[SECRET_REMOVED]
TELEGRAM_CHAT_ID=162853294

# –ü—Ä–æ—á–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
DEFAULT_TICKER=SBER
DEFAULT_DEPTH=5
DEFAULT_INTERVAL=10
LOG_LEVEL=INFO
LOG_TO_FILE=true
MOEX_TIMEOUT=10
ENCRYPT_TOKENS=false


# –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å account_id, –µ—Å–ª–∏ –∑–Ω–∞–µ—Ç–µ
# ACCOUNT_ID=your_account_id



================================================================================
–§–ê–ô–õ: .gitignore
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/.gitignore
================================================================================

# Virtual environment
trading_env/

# Environment variables
.env
.env.local

# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
build/
develop-eggs/
dist/
downloads/
eggs/
.eggs/
lib/
lib64/
parts/
sdist/
var/
wheels/
*.egg-info/
.installed.cfg
*.egg

# Logs
*.log
logs/

# IDE
.vscode/
.idea/
*.swp
*.swo

# Data files
*.csv
*.json
*.pkl
*.feather
*.parquet
data/

# Jupyter
.ipynb_checkpoints

# OS
.DS_Store
Thumbs.db


================================================================================
–§–ê–ô–õ: PROJECT_FULL_EXPORT_20251211_215801.txt
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/PROJECT_FULL_EXPORT_20251211_215801.txt
================================================================================



================================================================================
–§–ê–ô–õ: README.md
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/README.md
================================================================================

# Python Trading Bot

–¢–æ—Ä–≥–æ–≤—ã–π —Ä–æ–±–æ—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ç–æ—Ä–≥–æ–≤–ª–∏ –Ω–∞ —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö –±–∏—Ä–∂–∞—Ö (MOEX) —á–µ—Ä–µ–∑ Tinkoff Invest API.

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

### –û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞–ø–∫–∏:
- **`src/`** - –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ –ø—Ä–æ–µ–∫—Ç–∞
  - **`data_feed/`** - –º–æ–¥—É–ª–∏ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä—ã–Ω–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (—Å—Ç–∞–∫–∞–Ω—ã, –∫–æ—Ç–∏—Ä–æ–≤–∫–∏)
  - **`strategies/`** - —Ç–æ—Ä–≥–æ–≤—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ (–ø–æ–∫–∞ –ø—É—Å—Ç–æ)
  - **`execution/`** - –º–æ–¥—É–ª–∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞—è–≤–æ–∫ (–ø–æ–∫–∞ –ø—É—Å—Ç–æ)  
  - **`risk_management/`** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∏—Å–∫–∞–º–∏ (–ø–æ–∫–∞ –ø—É—Å—Ç–æ)
  - **`utils/`** - –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã (–ª–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)

- **`tests/`** - —Ç–µ—Å—Ç—ã –ø—Ä–æ–µ–∫—Ç–∞
- **`scripts/`** - –ø–æ–ª–µ–∑–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã (—Å–∫—Ä–∏–Ω–µ—Ä—ã, —ç–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö)
- **`project_utils/`** - —É—Ç–∏–ª–∏—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–æ–º (—ç–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç)
- **`config/`** - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
- **`notebooks/`** - Jupyter –Ω–æ—É—Ç–±—É–∫–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
- **`data/`** - –¥–∞–Ω–Ω—ã–µ (–∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –∫–æ—Ç–∏—Ä–æ–≤–∫–∏)
- **`logs/`** - –ª–æ–≥–∏ —Ä–∞–±–æ—Ç—ã

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
```bash
# –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
python -m venv trading_env

# –ê–∫—Ç–∏–≤–∞—Ü–∏—è (Linux/Mac)
source trading_env/bin/activate

# –ê–∫—Ç–∏–≤–∞—Ü–∏—è (Windows)  
trading_env\Scripts\activate

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
pip install -r requirements.txt
2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ API

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env –Ω–∞ –æ—Å–Ω–æ–≤–µ .env.example:

env
INVEST_TOKEN=your_tinkoff_invest_token_here
SANDBOX=true
3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏

bash
python test_setup.py
üîß –£—Ç–∏–ª–∏—Ç—ã –ø—Ä–æ–µ–∫—Ç–∞

–≠–∫—Å–ø–æ—Ä—Ç –ø—Ä–æ–µ–∫—Ç–∞

bash
python project_utils/export_project.py
–°–æ–∑–¥–∞–µ—Ç JSON —Ñ–∞–π–ª —Å–æ –≤—Å–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –ø—Ä–æ–µ–∫—Ç–∞.

–ò–º–ø–æ—Ä—Ç –ø—Ä–æ–µ–∫—Ç–∞

bash
python project_utils/import_project.py project_export_YYYYMMDD_HHMMSS.json
–†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç –ø—Ä–æ–µ–∫—Ç –∏–∑ —Ñ–∞–π–ª–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞.

üìä –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

–†–∞–±–æ—Ç–∞—é—â–∏–µ –º–æ–¥—É–ª–∏:

‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞–∫–∞–Ω–æ–≤ —Å MOEX
‚úÖ –†–∞–±–æ—Ç–∞ —Å Tinkoff Invest API (–±–æ–µ–≤–æ–π –∫–æ–Ω—Ç—É—Ä)
‚úÖ –°–∫—Ä–∏–Ω–µ—Ä—ã –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
‚úÖ –í—ã–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ:

üîÑ –¢–æ—Ä–≥–æ–≤—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
üîÑ –ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞—è–≤–æ–∫
üîÑ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∏—Å–∫–∞–º–∏
üîÑ –ë—ç–∫—Ç–µ—Å—Ç–∏–Ω–≥
üõ† –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

Python 3.8+
Tinkoff Invest API
MOEX ISS API
pandas, numpy –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
backtrader –¥–ª—è –±—ç–∫—Ç–µ—Å—Ç–∏–Ω–≥–∞
loguru –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
üìà –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

–ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–Ω–µ—Ä–∞ —Å—Ç–∞–∫–∞–Ω–æ–≤:

bash
python scripts/scanner_gazp.py
–¢–µ—Å—Ç Tinkoff API:

bash
python test_tinkoff_simple.py
‚ö†Ô∏è –í–∞–∂–Ω–æ

–ü—Ä–æ–µ–∫—Ç –≤ –∞–∫—Ç–∏–≤–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ
–¢–æ—Ä–≥–æ–≤–ª—è —Å–æ–ø—Ä—è–∂–µ–Ω–∞ —Å —Ä–∏—Å–∫–∞–º–∏
–í—Å–µ–≥–¥–∞ —Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –≤ sandbox —Ä–µ–∂–∏–º–µ
–°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –±—ç–∫–∞–ø—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏


================================================================================
–§–ê–ô–õ: check_install.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/check_install.py
================================================================================

print("üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É –æ—Å–Ω–æ–≤–Ω—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫...")

libs_to_check = [
    "pandas", "numpy", "requests", "ccxt", 
    "moexalex", "backtrader", "loguru", "python-dotenv"
]

for lib in libs_to_check:
    try:
        __import__(lib)
        print(f"‚úÖ {lib}")
    except ImportError as e:
        print(f"‚ùå {lib}: {e}")

print("\nüìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–π:")
import pandas as pd
import numpy as np
import ccxt

print(f"Pandas: {pd.__version__}")
print(f"Numpy: {np.__version__}")
print(f"CCXT: {ccxt.__version__}")

print("\nüéØ –ë–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")


================================================================================
–§–ê–ô–õ: check_project_structure.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/check_project_structure.py
================================================================================

import os
import sys

def check_structure():
    print("üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞...")
    
    # –û–∂–∏–¥–∞–µ–º–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏–∑ –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    expected_dirs = [
        'src',
        'src/data_feed', 
        'src/strategies',
        'src/execution',
        'src/risk_management',
        'src/utils',
        'tests',
        'config',
        'notebooks',
        'scripts',
        'data',
        'logs'
    ]
    
    expected_files = [
        'src/__init__.py',
        'src/data_feed/__init__.py',
        'src/strategies/__init__.py', 
        'src/execution/__init__.py',
        'src/risk_management/__init__.py',
        'src/utils/__init__.py',
        'tests/__init__.py',
        'requirements.txt',
        '.env'
    ]
    
    missing_dirs = []
    missing_files = []
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞–ø–∫–∏
    for dir_path in expected_dirs:
        if not os.path.exists(dir_path):
            missing_dirs.append(dir_path)
        else:
            print(f"‚úÖ –ü–∞–ø–∫–∞: {dir_path}")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª—ã
    for file_path in expected_files:
        if not os.path.exists(file_path):
            missing_files.append(file_path)
        else:
            print(f"‚úÖ –§–∞–π–ª: {file_path}")
    
    # –í—ã–≤–æ–¥–∏–º –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã
    if missing_dirs:
        print("\n‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–∞–ø–∫–∏:")
        for dir_path in missing_dirs:
            print(f"   - {dir_path}")
    
    if missing_files:
        print("\n‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã:")
        for file_path in missing_files:
            print(f"   - {file_path}")
    
    if not missing_dirs and not missing_files:
        print("\nüéâ –í—Å—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞!")
    else:
        print(f"\nüìù –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–∑–¥–∞—Ç—å: {len(missing_dirs)} –ø–∞–ø–æ–∫, {len(missing_files)} —Ñ–∞–π–ª–æ–≤")

if __name__ == "__main__":
    check_structure()


================================================================================
–§–ê–ô–õ: create_monolithic_export.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/create_monolithic_export.py
================================================================================

#!/usr/bin/env python3
"""
–°–æ–∑–¥–∞—ë—Ç –º–æ–Ω–æ–ª–∏—Ç–Ω—ã–π —Ñ–∞–π–ª —Å–æ –≤—Å–µ–º –∫–æ–¥–æ–º –ø—Ä–æ–µ–∫—Ç–∞
–ó–∞–ø—É—Å–∫: python create_monolithic_export.py [–ø—É—Ç—å_–∫_–ø—Ä–æ–µ–∫—Ç—É]
"""

import os
import sys
from pathlib import Path
from datetime import datetime

class MonolithicProjectExporter:
    def __init__(self, project_root="."):
        self.project_root = Path(project_root).resolve()
        self.output_file = None
        self.file_count = 0
        self.total_size = 0
        
        # –ü–∞–ø–∫–∏ –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è (—Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ)
        self.exclude_dirs = {
            '.git', '__pycache__', '.pytest_cache', '.mypy_cache',
            'trading_env', 'venv', '.venv', 'env', 'virtualenv',
            'node_modules', '.vscode', '.idea', 'logs', 'data',
            'build', 'dist', '.eggs', '*.egg-info'
        }
        
        # –§–∞–π–ª—ã –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
        self.exclude_files = {
            '.DS_Store', 'Thumbs.db', 'desktop.ini',
            '*.pyc', '*.pyo', '*.pyd', '*.so', '*.dll',
            '*.log', '*.tmp', '*.temp', '.coverage',
            '*.db', '*.sqlite', '*.db-journal'
        }
        
        # –†–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –º—ã —Ö–æ—Ç–∏–º –≤–∫–ª—é—á–∏—Ç—å (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å)
        self.include_extensions = {
            '.py', '.txt', '.md', '.json', '.yaml', '.yml',
            '.toml', '.ini', '.cfg', '.env', '.sh', '.bat',
            '.html', '.css', '.js', '.ts', '.sql', '.csv'
        }
        
    def should_include(self, path: Path) -> bool:
        """–û–ø—Ä–µ–¥–µ–ª—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –≤–∫–ª—é—á–∞—Ç—å —Ñ–∞–π–ª"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞–ø–∫–∏
        if path.is_dir():
            return path.name not in self.exclude_dirs and not any(
                path.match(pattern) for pattern in self.exclude_dirs if '*' in pattern
            )
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª—ã
        if any(path.match(pattern) for pattern in self.exclude_files):
            return False
            
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ)
        if path.suffix:
            return path.suffix in self.include_extensions
        
        # –§–∞–π–ª—ã –±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ –∏–º–µ–Ω–∏
        if path.name in ['.env', '.gitignore', 'Dockerfile', 'docker-compose.yml']:
            return True
            
        return False
    
    def sanitize_content(self, content: str, file_path: Path) -> str:
        """–û—á–∏—â–∞–µ–º —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ"""
        relative_path = str(file_path.relative_to(self.project_root))
        
        if file_path.name == '.env':
            lines = content.split('\n')
            cleaned_lines = []
            for line in lines:
                if any(keyword in line.upper() for keyword in 
                       ['TOKEN=', 'KEY=', 'SECRET=', 'PASSWORD=', 'API_']):
                    if '=' in line:
                        key = line.split('=')[0].strip()
                        cleaned_lines.append(f"{key}=[SECRET_REMOVED]")
                    else:
                        cleaned_lines.append(line)
                else:
                    cleaned_lines.append(line)
            return '\n'.join(cleaned_lines)
        
        return content
    
    def write_file_header(self, file_path: Path, relative_path: str):
        """–ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ñ–∞–π–ª–∞"""
        separator = "=" * 80
        self.output_file.write(f"\n\n{separator}\n")
        self.output_file.write(f"–§–ê–ô–õ: {relative_path}\n")
        self.output_file.write(f"–ü–û–õ–ù–´–ô –ü–£–¢–¨: {file_path}\n")
        self.output_file.write(f"{separator}\n\n")
    
    def process_file(self, file_path: Path):
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ–¥–∏–Ω —Ñ–∞–π–ª"""
        try:
            relative_path = str(file_path.relative_to(self.project_root))
            
            # –ü–∏—à–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            self.write_file_header(file_path, relative_path)
            
            # –ß–∏—Ç–∞–µ–º –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
            try:
                with open(file_path, 'r', encoding='utf-8') as f:
                    content = f.read()
                
                # –û—á–∏—â–∞–µ–º —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                content = self.sanitize_content(content, file_path)
                
                # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
                self.output_file.write(content)
                
                # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                self.file_count += 1
                self.total_size += len(content)
                
                print(f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω: {relative_path} ({len(content)} –±–∞–π—Ç)")
                
            except UnicodeDecodeError:
                # –ü—Ä–æ–±—É–µ–º –¥—Ä—É–≥–∏–µ –∫–æ–¥–∏—Ä–æ–≤–∫–∏
                try:
                    with open(file_path, 'r', encoding='latin-1') as f:
                        content = f.read()
                    self.output_file.write(f"# –§–∞–π–ª –≤ –∫–æ–¥–∏—Ä–æ–≤–∫–µ latin-1\n{content}")
                    self.file_count += 1
                except:
                    self.output_file.write(f"# –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª –∫–∞–∫ —Ç–µ–∫—Å—Ç (–±–∏–Ω–∞—Ä–Ω—ã–π —Ñ–∞–π–ª)\n")
                    self.output_file.write(f"# –†–∞–∑–º–µ—Ä: {file_path.stat().st_size} –±–∞–π—Ç\n")
                    
        except Exception as e:
            print(f"‚ö†Ô∏è  –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ {file_path}: {e}")
    
    def export_project(self, output_filename=None):
        """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞"""
        if not output_filename:
            timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
            output_filename = self.project_root / f"PROJECT_FULL_EXPORT_{timestamp}.txt"
        
        print(f"\nüöÄ –ù–∞—á–∏–Ω–∞–µ–º –º–æ–Ω–æ–ª–∏—Ç–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç –ø—Ä–æ–µ–∫—Ç–∞")
        print(f"üìÅ –ö–æ—Ä–Ω–µ–≤–∞—è –ø–∞–ø–∫–∞: {self.project_root}")
        print(f"üíæ –í—ã—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª: {output_filename}")
        print("=" * 60)
        
        try:
            self.output_file = open(output_filename, 'w', encoding='utf-8')
            
            # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —ç–∫—Å–ø–æ—Ä—Ç–∞
            self.write_export_header()
            
            # –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –æ–±—Ö–æ–¥–∏–º –≤—Å–µ —Ñ–∞–π–ª—ã
            for root, dirs, files in os.walk(self.project_root):
                # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º root –≤ Path
                root_path = Path(root)
                
                # –§–∏–ª—å—Ç—Ä—É–µ–º –ø–∞–ø–∫–∏
                dirs[:] = [d for d in dirs if self.should_include(root_path / d)]
                
                # –°–æ—Ä—Ç–∏—Ä—É–µ–º –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
                dirs.sort()
                files.sort()
                
                for file in files:
                    file_path = root_path / file
                    if self.should_include(file_path):
                        self.process_file(file_path)
            
            # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            self.write_statistics()
            
            # –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ñ–∞–π–ª
            self.output_file.close()
            
            print("\n" + "=" * 60)
            print(f"üéâ –≠–ö–°–ü–û–†–¢ –ó–ê–í–ï–†–®–Å–ù!")
            print(f"üìä –§–∞–π–ª–æ–≤ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ: {self.file_count}")
            print(f"üì¶ –û–±—â–∏–π —Ä–∞–∑–º–µ—Ä –∫–æ–¥–∞: {self.total_size / 1024:.1f} –ö–ë")
            print(f"üíæ –ò—Ç–æ–≥–æ–≤—ã–π —Ñ–∞–π–ª: {output_filename}")
            print(f"üìè –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: {output_filename.stat().st_size / 1024 / 1024:.2f} –ú–ë")
            print("=" * 60)
            
            return output_filename
            
        except Exception as e:
            print(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
            if self.output_file:
                self.output_file.close()
            return None
    
    def write_export_header(self):
        """–ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —ç–∫—Å–ø–æ—Ä—Ç–∞"""
        header = f"""
{'=' * 80}
–ú–û–ù–û–õ–ò–¢–ù–´–ô –≠–ö–°–ü–û–†–¢ –ü–†–û–ï–ö–¢–ê: {self.project_root.name}
{'=' * 80}

üìÖ –î–∞—Ç–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
üìÅ –ö–æ—Ä–Ω–µ–≤–∞—è –ø–∞–ø–∫–∞: {self.project_root}
üë§ –≠–∫—Å–ø–æ—Ä—Ç—ë—Ä: MonolithicProjectExporter v1.0

{'=' * 80}
–ü–†–ò–ú–ï–ß–ê–ù–ò–Ø:
1. –§–∞–π–ª—ã —Ä–∞–∑–¥–µ–ª–µ–Ω—ã –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ —Å '======'
2. –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (—Ç–æ–∫–µ–Ω—ã, –∫–ª—é—á–∏) –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ [SECRET_REMOVED]
3. –ë–∏–Ω–∞—Ä–Ω—ã–µ —Ñ–∞–π–ª—ã –ø—Ä–æ–ø—É—â–µ–Ω—ã, —Ç–æ–ª—å–∫–æ –∏—Ö –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
4. –í—Å–µ –ø—É—Ç–∏ —É–∫–∞–∑–∞–Ω—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞
{'=' * 80}

"""
        self.output_file.write(header)
    
    def write_statistics(self):
        """–ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ –∫–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞"""
        stats = f"""

{'=' * 80}
üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –≠–ö–°–ü–û–†–¢–ê
{'=' * 80}
–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤: {self.file_count}
–û–±—â–∏–π —Ä–∞–∑–º–µ—Ä –∫–æ–¥–∞: {self.total_size} –±–∞–π—Ç ({self.total_size / 1024:.1f} –ö–ë)
–î–∞—Ç–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
{'=' * 80}

üéØ –ò–ù–°–¢–†–£–ö–¶–ò–Ø –î–õ–Ø –ê–ù–ê–õ–ò–ó–ê:
1. –ò—â–∏—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ñ–∞–π–ª—ã –ø–æ —Å—Ç—Ä–æ–∫–µ "–§–ê–ô–õ: "
2. –í—Å–µ –ø—É—Ç–∏ —É–∫–∞–∑–∞–Ω—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ: {self.project_root}
3. –î–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
4. .env —Ñ–∞–π–ª—ã –æ—á–∏—â–µ–Ω—ã –æ—Ç —Å–µ–∫—Ä–µ—Ç–æ–≤

{'=' * 80}
–ö–û–ù–ï–¶ –≠–ö–°–ü–û–†–¢–ê
{'=' * 80}
"""
        self.output_file.write(stats)


def main():
    """–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞"""
    print("üîß Monolithic Project Exporter v1.0")
    print("–°–æ–∑–¥–∞—ë—Ç –µ–¥–∏–Ω—ã–π —Ñ–∞–π–ª —Å–æ –≤—Å–µ–º –∫–æ–¥–æ–º –ø—Ä–æ–µ–∫—Ç–∞")
    print("=" * 60)
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É
    if len(sys.argv) > 1:
        project_path = sys.argv[1]
        if not os.path.exists(project_path):
            print(f"‚ùå –ü—É—Ç—å –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: {project_path}")
            return
    else:
        project_path = "."
    
    # –°–æ–∑–¥–∞—ë–º —ç–∫—Å–ø–æ—Ä—Ç—ë—Ä –∏ –∑–∞–ø—É—Å–∫–∞–µ–º
    exporter = MonolithicProjectExporter(project_path)
    
    # –ú–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞ –≤—Ç–æ—Ä—ã–º –∞—Ä–≥—É–º–µ–Ω—Ç–æ–º
    output_file = None
    if len(sys.argv) > 2:
        output_file = Path(sys.argv[2])
    
    result = exporter.export_project(output_file)
    
    if result:
        print(f"\n‚úÖ –≠–∫—Å–ø–æ—Ä—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω: {result}")
        print("\nüìã –ë—ã—Å—Ç—Ä—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:")
        print(f"   –ü—Ä–æ—Å–º–æ—Ç—Ä: type {result} | more")
        print(f"   –ü–æ–∏—Å–∫ —Ñ–∞–π–ª–∞: findstr /n \"–§–ê–ô–õ: main.py\" {result}")
        print(f"   –ü–æ–¥—Å—á—ë—Ç —Å—Ç—Ä–æ–∫: find /c /v \"\" {result}")
    else:
        print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —ç–∫—Å–ø–æ—Ä—Ç")

if __name__ == "__main__":
    main()

================================================================================
–§–ê–ô–õ: debug_imports.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/debug_imports.py
================================================================================

import sys
import os

print("üîß Debug –ø—É—Ç–µ–π Python:")
print(f"–¢–µ–∫—É—â–∞—è –ø–∞–ø–∫–∞: {os.getcwd()}")
print(f"–ü—É—Ç–∏ Python:")
for path in sys.path:
    print(f"  - {path}")

print(f"\nüìÅ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ src/utils/:")
try:
    print(os.listdir("src/utils"))
except Exception as e:
    print(f"–û—à–∏–±–∫–∞: {e}")

print(f"\nüìÅ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ src/data_feed/:")
try:
    print(os.listdir("src/data_feed"))
except Exception as e:
    print(f"–û—à–∏–±–∫–∞: {e}")

# –ü—Ä—è–º–æ–π –∏–º–ø–æ—Ä—Ç
print(f"\nüîÑ –ü—Ä—è–º–æ–π –∏–º–ø–æ—Ä—Ç...")
try:
    import importlib.util
    spec = importlib.util.spec_from_file_location("logger", "src/utils/logger.py")
    logger_module = importlib.util.module_from_spec(spec)
    spec.loader.exec_module(logger_module)
    print("‚úÖ –ü—Ä—è–º–æ–π –∏–º–ø–æ—Ä—Ç logger.py - –£–°–ü–ï–•")
except Exception as e:
    print(f"‚ùå –ü—Ä—è–º–æ–π –∏–º–ø–æ—Ä—Ç logger.py: {e}")


================================================================================
–§–ê–ô–õ: debug_installation.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/debug_installation.py
================================================================================

import sys
print("Python –ø—É—Ç—å:", sys.executable)
print("–í–µ—Ä—Å–∏—è Python:", sys.version)

try:
    import pip
    installed_packages = [p.key for p in pip.get_installed_distributions()]
    print("–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø–∞–∫–µ—Ç—ã —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ 'tinkoff':", 
          [p for p in installed_packages if 'tinkoff' in p])
except:
    pass

# –ü—Ä–æ–≤–µ—Ä–∏–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥—É–ª–∏
import pkgutil
all_modules = [name for importer, name, ispkg in pkgutil.iter_modules()]
print("–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥—É–ª–∏:", [m for m in all_modules if 'tinkoff' in m or 'invest' in m])


================================================================================
–§–ê–ô–õ: main.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/main.py
================================================================================

#!/usr/bin/env python3
"""
–ì–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª trading –±–æ—Ç–∞
"""

import sys
import os

# –î–æ–±–∞–≤–ª—è–µ–º src –≤ –ø—É—Ç—å Python
sys.path.insert(0, os.path.join(os.path.dirname(__file__), 'src'))

from utils.logger import log
from data_feed.moex_client import MOEXClient

def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""
    log.info("üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º trading –±–æ—Ç...")
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
    client = MOEXClient()
    
    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ SBER
    sber_info = client.get_security_info("SBER")
    if sber_info:
        log.info("‚úÖ MOEX API —Ä–∞–±–æ—Ç–∞–µ—Ç")
    
    log.info("üéØ Trading –±–æ—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!")

if __name__ == "__main__":
    main()


================================================================================
–§–ê–ô–õ: moex_direct.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/moex_direct.py
================================================================================

import requests
import pandas as pd
from loguru import logger

class MOEXClient:
    def __init__(self):
        self.base_url = "https://iss.moex.com/iss"
        self.session = requests.Session()
        logger.info("MOEX –∫–ª–∏–µ–Ω—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
    
    def get_security_info(self, ticker):
        """–ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±—É–º–∞–≥–µ"""
        url = f"{self.base_url}/securities/{ticker}.json"
        try:
            response = self.session.get(url)
            response.raise_for_status()
            data = response.json()
            logger.info(f"–î–∞–Ω–Ω—ã–µ –ø–æ {ticker} –ø–æ–ª—É—á–µ–Ω—ã")
            return data
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ {ticker}: {e}")
            return None
    
    def get_current_price(self, ticker):
        """–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É (—É–ø—Ä–æ—â—ë–Ω–Ω–æ)"""
        url = f"{self.base_url}/engines/stock/markets/shares/boards/TQBR/securities/{ticker}.json"
        try:
            response = self.session.get(url)
            data = response.json()
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é —Ü–µ–Ω—É –∏–∑ —Ä—ã–Ω–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            market_data = data['marketdata']['data']
            if market_data:
                last_price = market_data[0][12]  # LAST —Ü–µ–Ω–∞
                return last_price
            return None
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ü–µ–Ω—ã {ticker}: {e}")
            return None

if __name__ == "__main__":
    client = MOEXClient()
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ SBER
    sber_info = client.get_security_info("SBER")
    if sber_info:
        print("‚úÖ –î–∞–Ω–Ω—ã–µ SBER –ø–æ–ª—É—á–µ–Ω—ã")
    
    sber_price = client.get_current_price("SBER")
    if sber_price:
        print(f"‚úÖ –¶–µ–Ω–∞ SBER: {sber_price}")


================================================================================
–§–ê–ô–õ: requirements.txt
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/requirements.txt
================================================================================

aiodns==3.5.0
aiohappyeyeballs==2.6.1
aiohttp==3.13.2
aiosignal==1.4.0
annotated-types==0.7.0
anyio==4.12.0
attrs==25.4.0
backtrader==1.9.78.123
beautifulsoup4==4.14.2
cachetools==5.5.2
ccxt==4.5.19
certifi==2025.11.12
cffi==2.0.0
charset-normalizer==3.4.4
coincurve==21.0.0
contourpy==1.3.3
cryptography==46.0.3
cycler==0.12.1
dateparser==1.2.2
deprecation==2.1.0
fonttools==4.60.1
frozenlist==1.8.0
grpcio==1.76.0
h11==0.16.0
httpcore==1.0.9
httpx==0.28.1
idna==3.11
iso8601==2.1.0
joblib==1.5.2
kiwisolver==1.4.9
loguru==0.7.3
matplotlib==3.10.7
multidict==6.7.0
narwhals==2.11.0
numpy==2.3.4
packaging==25.0
pandas==2.3.3
pillow==12.0.0
plotly==6.4.0
prettytable==3.17.0
propcache==0.4.1
protobuf==4.25.8
pycares==4.11.0
pycparser==2.23
pycryptodome==3.23.0
pydantic==2.12.4
pydantic_core==2.41.5
pyparsing==3.2.5
python-binance==1.0.32
python-dateutil==2.9.0.post0
python-dotenv==1.2.1
python-telegram-bot==22.5
pytz==2025.2
regex==2025.11.3
requests==2.32.5
scikit-learn==1.7.2
scipy==1.16.3
seaborn==0.13.2
six==1.17.0
soupsieve==2.8
threadpoolctl==3.6.0
tinkoff==0.1.1
tinkoff-investments==0.2.0b117
typing-inspection==0.4.2
typing_extensions==4.15.0
tzdata==2025.2
tzlocal==5.3.1
ujson==5.11.0
urllib3==2.5.0
wcwidth==0.2.14
websocket-client==1.9.0
websockets==15.0.1
yarl==1.22.0


================================================================================
–§–ê–ô–õ: testGit.txt
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/testGit.txt
================================================================================



================================================================================
–§–ê–ô–õ: test_debug.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/test_debug.py
================================================================================

import os
from dotenv import load_dotenv
load_dotenv()

from tinkoff.invest import Client

token = os.getenv('INVEST_TOKEN')
with Client(token) as client:
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –≤—ã–∑–æ–≤–∞
    from tinkoff.invest.schemas import GetOrderBookRequest
    
    # –í–∞—Ä–∏–∞–Ω—Ç 1
    try:
        request = GetOrderBookRequest(figi="BBG004730N88", depth=5)
        result = client.market_data.get_order_book(request)
        print("‚úÖ –í–∞—Ä–∏–∞–Ω—Ç 1 —Å GetOrderBookRequest —Ä–∞–±–æ—Ç–∞–µ—Ç")
    except Exception as e:
        print(f"‚ùå –í–∞—Ä–∏–∞–Ω—Ç 1: {e}")
    
    # –í–∞—Ä–∏–∞–Ω—Ç 2  
    try:
        result = client.market_data.get_order_book(figi="BBG004730N88", depth=5)
        print("‚úÖ –í–∞—Ä–∏–∞–Ω—Ç 2 —Å –ø—Ä—è–º—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç")
    except Exception as e:
        print(f"‚ùå –í–∞—Ä–∏–∞–Ω—Ç 2: {e}")



================================================================================
–§–ê–ô–õ: test_fixed_imports.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/test_fixed_imports.py
================================================================================

#!/usr/bin/env python3
"""
–¢–µ—Å—Ç –∏–º–ø–æ—Ä—Ç–æ–≤ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π
"""

import sys
from pathlib import Path

# –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ –≤ –ø—É—Ç—å Python
project_root = Path(__file__).parent
sys.path.insert(0, str(project_root))

print("üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã...")

try:
    from telegram_bot.config import bot_state, TELEGRAM_BOT_TOKEN
    print("‚úÖ config.py")
except Exception as e:
    print(f"‚ùå config.py: {e}")

try:
    from telegram_bot.handlers.basic import start, help_command, status
    print("‚úÖ handlers.basic")
except Exception as e:
    print(f"‚ùå handlers.basic: {e}")

try:
    from telegram_bot.handlers.settings import set_ticker, set_depth, set_interval
    print("‚úÖ handlers.settings")
except Exception as e:
    print(f"‚ùå handlers.settings: {e}")

try:
    from telegram_bot.handlers.orderbook import get_orderbook, start_monitoring, stop_monitoring
    print("‚úÖ handlers.orderbook")
except Exception as e:
    print(f"‚ùå handlers.orderbook: {e}")

try:
    from telegram_bot.services.orderbook_service import get_orderbook as get_orderbook_data, format_orderbook_message
    print("‚úÖ services.orderbook_service")
except Exception as e:
    print(f"‚ùå services.orderbook_service: {e}")

try:
    from telegram_bot.services.tinkoff_service import get_tinkoff_service, format_orderbook_for_telegram
    print("‚úÖ services.tinkoff_service")
except Exception as e:
    print(f"‚ùå services.tinkoff_service: {e}")

print("\nüéØ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–ø–æ—Ä—Ç–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")


================================================================================
–§–ê–ô–õ: test_imports.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/test_imports.py
================================================================================

#!/usr/bin/env python3
"""
–¢–µ—Å—Ç –∏–º–ø–æ—Ä—Ç–æ–≤ –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π –±–æ—Ç–∞
"""

import sys
from pathlib import Path

# –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ –≤ –ø—É—Ç—å Python
project_root = Path(__file__).parent
sys.path.insert(0, str(project_root))

print("üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–º–ø–æ—Ä—Ç—ã –º–æ–¥—É–ª–µ–π –±–æ—Ç–∞...")

try:
    from telegram_bot.config import bot_state, TELEGRAM_BOT_TOKEN
    print("‚úÖ config.py")
except Exception as e:
    print(f"‚ùå config.py: {e}")

try:
    from telegram_bot.handlers.basic import start, help_command, status
    print("‚úÖ handlers.basic")
except Exception as e:
    print(f"‚ùå handlers.basic: {e}")

try:
    from telegram_bot.handlers.settings import set_ticker, set_depth, set_interval
    print("‚úÖ handlers.settings")
except Exception as e:
    print(f"‚ùå handlers.settings: {e}")

try:
    from telegram_bot.handlers.orderbook import get_orderbook, start_monitoring, stop_monitoring
    print("‚úÖ handlers.orderbook")
except Exception as e:
    print(f"‚ùå handlers.orderbook: {e}")

try:
    from telegram_bot.services.orderbook_service import get_orderbook as get_orderbook_data
    print("‚úÖ services.orderbook_service")
except Exception as e:
    print(f"‚ùå services.orderbook_service: {e}")

print("\nüéØ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–ø–æ—Ä—Ç–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")


================================================================================
–§–ê–ô–õ: test_instruments.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/test_instruments.py
================================================================================

#!/usr/bin/env python3
"""
–¢–µ—Å—Ç –ø–æ–∏—Å–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
"""

import os
import sys
from dotenv import load_dotenv

# –î–æ–±–∞–≤–ª—è–µ–º src –≤ –ø—É—Ç—å Python
sys.path.insert(0, os.path.join(os.path.dirname(__file__), 'src'))

load_dotenv()

def main():
    print("üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–∏—Å–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤...")
    
    token = os.getenv('INVEST_TOKEN')
    if not token:
        print("‚ùå –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω")
        return
    
    try:
        from tinkoff.invest import Client
        from tinkoff.invest.schemas import InstrumentStatus
        
        with Client(token) as client:
            # –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–∏—Å–∫ SBER
            instruments = client.instruments.find_instrument(query="SBER")
            print(f"üîç –ù–∞–π–¥–µ–Ω–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –ø–æ SBER: {len(instruments.instruments)}")
            
            for i, instrument in enumerate(instruments.instruments[:3]):  # –ü–æ–∫–∞–∂–µ–º –ø–µ—Ä–≤—ã–µ 3
                print(f"\n–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç {i+1}:")
                print(f"  –¢–∏–∫–µ—Ä: {instrument.ticker}")
                print(f"  –ù–∞–∑–≤–∞–Ω–∏–µ: {instrument.name}")
                print(f"  FIGI: {instrument.figi}")
                print(f"  State: {instrument.state}")
                print(f"  Status: {InstrumentStatus(instrument.state).name}")
                
                # –ü–æ–∫–∞–∂–µ–º –≤—Å–µ –∞—Ç—Ä–∏–±—É—Ç—ã –æ–±—ä–µ–∫—Ç–∞
                print(f"  –í—Å–µ –∞—Ç—Ä–∏–±—É—Ç—ã: {[attr for attr in dir(instrument) if not attr.startswith('_')]}")
                
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")

if __name__ == "__main__":
    main()


================================================================================
–§–ê–ô–õ: test_orderbook.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/test_orderbook.py
================================================================================

#!/usr/bin/env python3
"""
–ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç —Å—Ç–∞–∫–∞–Ω–∞ - –∑–∞–ø—É—Å–∫–∞—Ç—å –∏–∑ –∫–æ—Ä–Ω–µ–≤–æ–π –ø–∞–ø–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞
"""

import sys
import os

# –î–æ–±–∞–≤–ª—è–µ–º src –≤ –ø—É—Ç—å Python
sys.path.insert(0, os.path.join(os.path.dirname(__file__), 'src'))

from data_feed.orderbook import MOEXOrderbook

def main():
    print("üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å—Ç–∞–∫–∞–Ω...")
    
    client = MOEXOrderbook()
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –Ω–∞ SBER (–æ–Ω –≤—Å–µ–≥–¥–∞ —Ç–æ—Ä–≥—É–µ—Ç—Å—è)
    print("üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞–∫–∞–Ω SBER...")
    client.print_pretty_orderbook("SBER")
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –Ω–∞ GAZP
    print("\nüîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞–∫–∞–Ω GAZP...")
    client.print_pretty_orderbook("GAZP")

if __name__ == "__main__":
    main()


================================================================================
–§–ê–ô–õ: test_setup.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/test_setup.py
================================================================================

print("üéâ –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!")
print("–í—ã –≤ –ø–∞–ø–∫–µ:", __file__)

import sys
print("Python –ø—É—Ç—å:", sys.executable)

# –ü—Ä–æ–≤–µ—Ä–∏–º –æ—Å–Ω–æ–≤–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
try:
    import pandas as pd
    print("‚úÖ pandas —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
except ImportError:
    print("‚ùå pandas –ù–ï —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")

try:
    import numpy as np
    print("‚úÖ numpy —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω") 
except ImportError:
    print("‚ùå numpy –ù–ï —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")


================================================================================
–§–ê–ô–õ: test_tinkoff.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/test_tinkoff.py
================================================================================

#!/usr/bin/env python3
"""
–¢–µ—Å—Ç Tinkoff API - –∑–∞–ø—É—Å–∫–∞—Ç—å –∏–∑ –∫–æ—Ä–Ω–µ–≤–æ–π –ø–∞–ø–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞
"""

import sys
import os

# –î–æ–±–∞–≤–ª—è–µ–º src –≤ –ø—É—Ç—å Python
sys.path.insert(0, os.path.join(os.path.dirname(__file__), 'src'))

from data_feed.tinkoff_client import TinkoffAPIClient

def main():
    print("üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º Tinkoff API...")
    
    try:
        client = TinkoffAPIClient()
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –Ω–∞ SBER
        print("üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞–∫–∞–Ω SBER...")
        client.print_pretty_orderbook("SBER")
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –Ω–∞ GAZP
        print("\nüîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞–∫–∞–Ω GAZP...")
        client.print_pretty_orderbook("GAZP")
        
    except Exception as e:
        print(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
        print("‚ÑπÔ∏è  –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:")
        print("   - –¢–æ–∫–µ–Ω –≤ .env —Ñ–∞–π–ª–µ")
        print("   - –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É")
        print("   - –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å —Ñ–æ—Ä–º–∞—Ç–∞ —Ç–æ–∫–µ–Ω–∞")

if __name__ == "__main__":
    main()


================================================================================
–§–ê–ô–õ: test_tinkoff_simple.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/test_tinkoff_simple.py
================================================================================

#!/usr/bin/env python3
"""
–ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç Tinkoff API (–±–æ–µ–≤–æ–π –∫–æ–Ω—Ç—É—Ä)
"""

import os
import sys
from dotenv import load_dotenv

# –î–æ–±–∞–≤–ª—è–µ–º src –≤ –ø—É—Ç—å Python
sys.path.insert(0, os.path.join(os.path.dirname(__file__), 'src'))

load_dotenv()

def main():
    print("üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Tinkoff API...")
    
    token = os.getenv('INVEST_TOKEN')
    if not token:
        print("‚ùå –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env —Ñ–∞–π–ª–µ")
        return
    
    try:
        from tinkoff.invest import Client
        
        with Client(token) as client:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å—á–µ—Ç–∞
            accounts = client.users.get_accounts()
            print("‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ!")
            print(f"üìã –ù–∞–π–¥–µ–Ω–æ —Å—á–µ—Ç–æ–≤: {len(accounts.accounts)}")
            
            for account in accounts.accounts:
                print(f"   - {account.name} (ID: {account.id})")
                
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: {e}")

if __name__ == "__main__":
    main()


================================================================================
–§–ê–ô–õ: test_vscode.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/test_vscode.py
================================================================================

import sys
print("üéØ VSCode —Ç–µ—Å—Ç –∑–∞–ø—É—â–µ–Ω!")
print(f"Python –ø—É—Ç—å: {sys.executable}")
print(f"–í–µ—Ä—Å–∏—è Python: {sys.version}")

if "trading_env" in sys.executable:
    print("‚úÖ –†–∞–±–æ—Ç–∞–µ–º –≤ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏!")
else:
    print("‚ùå –ù–ï –≤ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏!")

import os
print(f"üìÅ –ü—É—Ç—å: {os.getcwd()}")


================================================================================
–§–ê–ô–õ: working_requirements.txt
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/working_requirements.txt
================================================================================

aiodns==3.5.0
aiohappyeyeballs==2.6.1
aiohttp==3.13.2
aiosignal==1.4.0
annotated-types==0.7.0
anyio==4.12.0
attrs==25.4.0
backtrader==1.9.78.123
beautifulsoup4==4.14.2
cachetools==5.5.2
ccxt==4.5.19
certifi==2025.11.12
cffi==2.0.0
charset-normalizer==3.4.4
coincurve==21.0.0
contourpy==1.3.3
cryptography==46.0.3
cycler==0.12.1
dateparser==1.2.2
deprecation==2.1.0
fonttools==4.60.1
frozenlist==1.8.0
grpcio==1.76.0
h11==0.16.0
httpcore==1.0.9
httpx==0.28.1
idna==3.11
iso8601==2.1.0
joblib==1.5.2
kiwisolver==1.4.9
loguru==0.7.3
matplotlib==3.10.7
multidict==6.7.0
narwhals==2.11.0
numpy==2.3.4
packaging==25.0
pandas==2.3.3
pillow==12.0.0
plotly==6.4.0
prettytable==3.17.0
propcache==0.4.1
protobuf==4.25.8
pycares==4.11.0
pycparser==2.23
pycryptodome==3.23.0
pydantic==2.12.4
pydantic_core==2.41.5
pyparsing==3.2.5
python-binance==1.0.32
python-dateutil==2.9.0.post0
python-dotenv==1.2.1
python-telegram-bot==22.5
pytz==2025.2
regex==2025.11.3
requests==2.32.5
scikit-learn==1.7.2
scipy==1.16.3
seaborn==0.13.2
six==1.17.0
soupsieve==2.8
threadpoolctl==3.6.0
tinkoff==0.1.1
tinkoff-investments==0.2.0b117
typing-inspection==0.4.2
typing_extensions==4.15.0
tzdata==2025.2
tzlocal==5.3.1
ujson==5.11.0
urllib3==2.5.0
wcwidth==0.2.14
websocket-client==1.9.0
websockets==15.0.1
yarl==1.22.0


================================================================================
–§–ê–ô–õ: project_utils/export_project.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/project_utils/export_project.py
================================================================================

#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –≤—ã–≥—Ä—É–∑–∫–∏ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –≤ –æ–¥–∏–Ω —Ñ–∞–π–ª
–ó–∞–ø—É—Å–∫: python project_utils/export_project.py
"""

import os
import json
import base64
from datetime import datetime

def export_project():
    """–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –≤–µ—Å—å –ø—Ä–æ–µ–∫—Ç –≤ –æ–¥–∏–Ω JSON —Ñ–∞–π–ª"""
    print("üì§ –í—ã–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞...")
    
    project_data = {
        "export_date": datetime.now().isoformat(),
        "project_name": "Python Trading Bot",
        "files": {}
    }
    
    # –ò—Å–∫–ª—é—á–∞–µ–º—ã–µ –ø–∞–ø–∫–∏ –∏ —Ñ–∞–π–ª—ã
    exclude_dirs = {'.git', '__pycache__', 'trading_env', 'data', 'logs'}
    exclude_files = {'.DS_Store'}
    
    # –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞
    for root, dirs, files in os.walk("."):
        # –ò—Å–∫–ª—é—á–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø–∞–ø–∫–∏
        dirs[:] = [d for d in dirs if d not in exclude_dirs]
        
        for file in files:
            if file in exclude_files:
                continue
                
            file_path = os.path.join(root, file)
            relative_path = file_path[2:]  # —É–±–∏—Ä–∞–µ–º ./
            
            # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–∞–º —Å–∫—Ä–∏–ø—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞
            if "project_utils/export_project.py" in relative_path:
                continue
                
            try:
                with open(file_path, 'r', encoding='utf-8') as f:
                    content = f.read()
                
                # –î–ª—è .env —Ñ–∞–π–ª–∞ –∑–∞–º–µ–Ω—è–µ–º —Ç–æ–∫–µ–Ω –Ω–∞ placeholder
                if file == '.env':
                    lines = content.split('\n')
                    new_lines = []
                    for line in lines:
                        if line.startswith('INVEST_TOKEN='):
                            new_lines.append('INVEST_TOKEN=–í–≤–µ–¥–∏—Ç–µ –≤–∞—à —Ç–æ–∫–µ–Ω')
                        else:
                            new_lines.append(line)
                    content = '\n'.join(new_lines)
                
                project_data["files"][relative_path] = {
                    "content": content,
                    "size": len(content),
                    "encoding": "utf-8"
                }
                
                print(f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω: {relative_path}")
                
            except Exception as e:
                print(f"‚ö†Ô∏è  –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è {relative_path}: {e}")
                project_data["files"][relative_path] = {
                    "content": f"# –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: {e}",
                    "size": 0,
                    "error": str(e)
                }
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ñ–∞–π–ª
    output_filename = f"project_export_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
    
    try:
        with open(output_filename, 'w', encoding='utf-8') as f:
            json.dump(project_data, f, indent=2, ensure_ascii=False)
        
        file_size = os.path.getsize(output_filename) / 1024 / 1024
        print(f"\nüéâ –ü—Ä–æ–µ–∫—Ç —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤: {output_filename}")
        print(f"üìä –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: {file_size:.2f} MB")
        print(f"üìÅ –§–∞–π–ª–æ–≤ –≤ —ç–∫—Å–ø–æ—Ä—Ç–µ: {len(project_data['files'])}")
        print("\nüìã –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø—Ä–æ–µ–∫—Ç–∞:")
        
        # –í—ã–≤–æ–¥–∏–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É
        for file_path in sorted(project_data["files"].keys()):
            file_info = project_data["files"][file_path]
            print(f"  - {file_path} ({file_info['size']} –±–∞–π—Ç)")
            
        return True
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞: {e}")
        return False

def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""
    print("üöÄ Trading Bot Project Exporter")
    print("=" * 50)
    print("–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ –≤ –æ–¥–∏–Ω JSON —Ñ–∞–π–ª")
    print("–¢–æ–∫–µ–Ω API –∑–∞–º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ '–í–≤–µ–¥–∏—Ç–µ –≤–∞—à —Ç–æ–∫–µ–Ω'")
    print("=" * 50)
    
    success = export_project()
    
    if success:
        print("\n‚úÖ –≠–∫—Å–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!")
        print("üí° –ü–µ—Ä–µ–¥–∞–π—Ç–µ JSON —Ñ–∞–π–ª –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞")
    else:
        print("\n‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –ø—Ä–æ–µ–∫—Ç–∞")

if __name__ == "__main__":
    main()


================================================================================
–§–ê–ô–õ: scripts/__init__.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/scripts/__init__.py
================================================================================



================================================================================
–§–ê–ô–õ: scripts/auto_ru_parser.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/scripts/auto_ru_parser.py
================================================================================

#!/usr/bin/env python3
"""
–ü–∞—Ä—Å–µ—Ä –¥–ª—è auto.ru - —Å–±–æ—Ä –º–∞—Ä–æ–∫ –∏ –º–æ–¥–µ–ª–µ–π –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π
"""

import requests
import csv
import time
import os
from bs4 import BeautifulSoup
from urllib.parse import urljoin
import sys

# –î–æ–±–∞–≤–ª—è–µ–º src –≤ –ø—É—Ç—å Python –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –ª–æ–≥–≥–µ—Ä–∞
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..', 'src'))

from utils.logger import log

class AutoRuParser:
    def __init__(self):
        self.session = requests.Session()
        self.session.headers.update({
            'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
            'Accept-Language': 'ru-RU,ru;q=0.8,en-US;q=0.5,en;q=0.3',
            'Accept-Encoding': 'gzip, deflate, br',
            'Connection': 'keep-alive',
            'Upgrade-Insecure-Requests': '1',
        })
        self.base_url = "https://auto.ru"
        
    def get_page(self, url):
        """–ü–æ–ª—É—á–∞–µ–º HTML —Å—Ç—Ä–∞–Ω–∏—Ü—É"""
        try:
            log.info(f"üìÑ –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É: {url}")
            response = self.session.get(url, timeout=10)
            response.raise_for_status()
            return response.text
        except Exception as e:
            log.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã {url}: {e}")
            return None
    
    def parse_brands_and_models(self, url, vehicle_type):
        """–ü–∞—Ä—Å–∏–º –º–∞—Ä–∫–∏ –∏ –º–æ–¥–µ–ª–∏ —Å —É–∫–∞–∑–∞–Ω–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã"""
        html = self.get_page(url)
        if not html:
            return []
        
        soup = BeautifulSoup(html, 'html.parser')
        brands_data = []
        
        # –ò—â–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –º–∞—Ä–∫–∞–º–∏ (–º–æ–∂–µ—Ç –±—ã—Ç—å –≤ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ)
        brand_selectors = [
            'select[name="mark"] option',
            '.Select[data-ga-name="mark"] option',
            '[data-ftid="sales__filter_mark"] option',
            'select[data-ftid="sales__filter_mark"] option'
        ]
        
        brand_options = None
        for selector in brand_selectors:
            brand_options = soup.select(selector)
            if brand_options:
                log.info(f"‚úÖ –ù–∞—à–ª–∏ —Å–µ–ª–µ–∫—Ç–æ—Ä –º–∞—Ä–æ–∫: {selector}")
                break
        
        if not brand_options:
            log.warning(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Å–ø–∏—Å–æ–∫ –º–∞—Ä–æ–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ {url}")
            # –ü–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ —Å—Å—ã–ª–∫–∏ –Ω–∞ –º–∞—Ä–∫–∏ –¥—Ä—É–≥–∏–º —Å–ø–æ—Å–æ–±–æ–º
            brand_links = soup.select('a[href*="/cars/"]')
            log.info(f"üîó –ù–∞–π–¥–µ–Ω–æ —Å—Å—ã–ª–æ–∫ –Ω–∞ –º–∞—Ä–∫–∏: {len(brand_links)}")
            return []
        
        log.info(f"üè∑Ô∏è –ù–∞–π–¥–µ–Ω–æ –º–∞—Ä–æ–∫: {len(brand_links)}")
        
        # –ü–∞—Ä—Å–∏–º –∫–∞–∂–¥—É—é –º–∞—Ä–∫—É
        for option in brand_links:
            brand_name = option.get_text(strip=True)
            brand_value = option.get('value') or option.get('href', '')
            
            if not brand_name or brand_name in ['–õ—é–±–∞—è', '–í—Å–µ –º–∞—Ä–∫–∏', '']:
                continue
                
            log.info(f"üîç –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –º–∞—Ä–∫—É: {brand_name}")
            
            # –ü–æ–ª—É—á–∞–µ–º –º–æ–¥–µ–ª–∏ –¥–ª—è —ç—Ç–æ–π –º–∞—Ä–∫–∏
            models = self.get_models_for_brand(brand_name, brand_value, vehicle_type)
            
            for model_name in models:
                brands_data.append({
                    'brand': brand_name,
                    'model': model_name,
                    'vehicle_type': vehicle_type
                })
            
            # –ó–∞–¥–µ—Ä–∂–∫–∞ —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å —Å–µ—Ä–≤–µ—Ä
            time.sleep(1)
        
        return brands_data
    
    def get_models_for_brand(self, brand_name, brand_value, vehicle_type):
        """–ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –º–∞—Ä–∫–∏"""
        models = []
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º URL –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å –º–æ–¥–µ–ª—è–º–∏
        if 'cars' in vehicle_type.lower():
            model_url = f"https://auto.ru/nizhniy_novgorod/cars/{brand_name.lower()}/all/"
        else:
            model_url = f"https://auto.ru/nizhniy_novgorod/lcv/{brand_name.lower()}/all/"
        
        html = self.get_page(model_url)
        if not html:
            return models
        
        soup = BeautifulSoup(html, 'html.parser')
        
        # –ò—â–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä –º–æ–¥–µ–ª–µ–π
        model_selectors = [
            'select[name="model"] option',
            '.Select[data-ga-name="model"] option',
            '[data-ftid="sales__filter_model"] option',
            'select[data-ftid="sales__filter_model"] option'
        ]
        
        model_options = None
        for selector in model_selectors:
            model_options = soup.select(selector)
            if model_options:
                break
        
        if model_options:
            for option in model_options:
                model_name = option.get_text(strip=True)
                if model_name and model_name not in ['–õ—é–±–∞—è', '–í—Å–µ –º–æ–¥–µ–ª–∏', '']:
                    models.append(model_name)
        
        log.info(f"   üöó –ù–∞–π–¥–µ–Ω–æ –º–æ–¥–µ–ª–µ–π –¥–ª—è {brand_name}: {len(models)}")
        return models
    
    def save_to_csv(self, data, filename):
        """–°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ CSV —Ñ–∞–π–ª"""
        desktop_path = os.path.join(os.path.expanduser("~"), "Desktop")
        filepath = os.path.join(desktop_path, filename)
        
        try:
            with open(filepath, 'w', newline='', encoding='utf-8') as csvfile:
                fieldnames = ['brand', 'model', 'vehicle_type']
                writer = csv.DictWriter(csvfile, fieldnames=fieldnames)
                
                writer.writeheader()
                for row in data:
                    writer.writerow(row)
            
            log.info(f"üíæ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤: {filepath}")
            log.info(f"üìä –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: {len(data)}")
            return True
            
        except Exception as e:
            log.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ CSV: {e}")
            return False
    
    def run_parser(self):
        """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–∞—Ä—Å–µ—Ä–∞"""
        log.info("üöó –ó–∞–ø—É—Å–∫–∞–µ–º –ø–∞—Ä—Å–µ—Ä Auto.ru...")
        
        all_data = []
        
        # –ü–∞—Ä—Å–∏–º –ª–µ–≥–∫–æ–≤—ã–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏
        log.info("üîç –ü–∞—Ä—Å–∏–º —Ä–∞–∑–¥–µ–ª '–õ–µ–≥–∫–æ–≤—ã–µ –∞–≤—Ç–æ'...")
        cars_url = "https://auto.ru/nizhniy_novgorod/cars/all/"
        cars_data = self.parse_brands_and_models(cars_url, "–õ–µ–≥–∫–æ–≤–æ–π")
        all_data.extend(cars_data)
        
        # –ü–∞—Ä—Å–∏–º –ª–µ–≥–∫–∏–µ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏
        log.info("üîç –ü–∞—Ä—Å–∏–º —Ä–∞–∑–¥–µ–ª '–õ—ë–≥–∫–∏–µ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏–µ –∞–≤—Ç–æ'...")
        lcv_url = "https://auto.ru/nizhniy_novgorod/lcv/all/"
        lcv_data = self.parse_brands_and_models(lcv_url, "–ì—Ä—É–∑–æ–≤–æ–π")
        all_data.extend(lcv_data)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        if all_data:
            self.save_to_csv(all_data, "auto_ru_brands_models.csv")
            log.info("‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!")
        else:
            log.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–±—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ")
        
        return all_data

def main():
    """–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞"""
    try:
        parser = AutoRuParser()
        parser.run_parser()
        
    except Exception as e:
        log.error(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")

if __name__ == "__main__":
    main()


================================================================================
–§–ê–ô–õ: scripts/auto_ru_parser_simple.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/scripts/auto_ru_parser_simple.py
================================================================================

#!/usr/bin/env python3
"""
–£–ø—Ä–æ—â–µ–Ω–Ω—ã–π –ø–∞—Ä—Å–µ—Ä –¥–ª—è auto.ru
"""

import requests
import csv
import os
import sys
import json
import time

sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..', 'src'))

from utils.logger import log

class SimpleAutoRuParser:
    def __init__(self):
        self.session = requests.Session()
        self.session.headers.update({
            'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36',
            'Accept': 'application/json, text/plain, */*',
        })
    
    def get_api_data(self, category):
        """–ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ API auto.ru"""
        url = f"https://auto.ru/-/ajax/desktop/listing/"
        params = {
            'section': 'all',
            'category': category,
            'sort': 'fresh_relevance_1-desc'
        }
        
        try:
            log.info(f"üîß –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ API –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: {category}")
            response = self.session.get(url, params=params, timeout=10)
            response.raise_for_status()
            
            data = response.json()
            return data
            
        except Exception as e:
            log.error(f"‚ùå –û—à–∏–±–∫–∞ API –¥–ª—è {category}: {e}")
            return None
    
    def extract_brands_from_api(self, api_data, vehicle_type):
        """–ò–∑–≤–ª–µ–∫–∞–µ–º –±—Ä–µ–Ω–¥—ã –∏–∑ API –¥–∞–Ω–Ω—ã—Ö"""
        brands_data = []
        
        if not api_data or 'state' not in api_data:
            return brands_data
        
        state = api_data['state']
        
        # –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –ø—É—Ç–∏ –∫ –¥–∞–Ω–Ω—ã–º –æ –±—Ä–µ–Ω–¥–∞—Ö
        possible_paths = [
            state.get('listing', {}).get('data', {}).get('filters', {}).get('mark', []),
            state.get('filters', {}).get('mark', []),
            state.get('mark', [])
        ]
        
        marks = []
        for path in possible_paths:
            if path and isinstance(path, list) and len(path) > 0:
                marks = path
                break
        
        log.info(f"üè∑Ô∏è –ù–∞–π–¥–µ–Ω–æ –º–∞—Ä–æ–∫ –≤ API: {len(marks)}")
        
        for mark in marks:
            if isinstance(mark, dict):
                brand_name = mark.get('name', mark.get('title', ''))
                if brand_name and brand_name not in ['–õ—é–±–∞—è', '–í—Å–µ –º–∞—Ä–∫–∏']:
                    # –î–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è –¥–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫—É –±–µ–∑ –º–æ–¥–µ–ª–µ–π
                    brands_data.append({
                        'brand': brand_name,
                        'model': '–í—Å–µ –º–æ–¥–µ–ª–∏',
                        'vehicle_type': vehicle_type
                    })
        
        return brands_data
    
    def run_parser(self):
        """–ó–∞–ø—É—Å–∫–∞–µ–º –ø–∞—Ä—Å–µ—Ä"""
        log.info("üöó –ó–∞–ø—É—Å–∫–∞–µ–º —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π –ø–∞—Ä—Å–µ—Ä Auto.ru...")
        
        all_data = []
        
        # –õ–µ–≥–∫–æ–≤—ã–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏
        cars_data = self.get_api_data('cars')
        if cars_data:
            cars_brands = self.extract_brands_from_api(cars_data, "–õ–µ–≥–∫–æ–≤–æ–π")
            all_data.extend(cars_brands)
        
        time.sleep(2)  # –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
        
        # –ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏
        lcv_data = self.get_api_data('lcv')
        if lcv_data:
            lcv_brands = self.extract_brands_from_api(lcv_data, "–ì—Ä—É–∑–æ–≤–æ–π")
            all_data.extend(lcv_brands)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ CSV
        if all_data:
            desktop_path = os.path.join(os.path.expanduser("~"), "Desktop")
            filepath = os.path.join(desktop_path, "auto_ru_brands_simple.csv")
            
            with open(filepath, 'w', newline='', encoding='utf-8') as csvfile:
                writer = csv.DictWriter(csvfile, fieldnames=['brand', 'model', 'vehicle_type'])
                writer.writeheader()
                writer.writerows(all_data)
            
            log.info(f"üíæ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤: {filepath}")
            log.info(f"üìä –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: {len(all_data)}")
        else:
            log.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–±—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ")
        
        return all_data

def main():
    try:
        parser = SimpleAutoRuParser()
        parser.run_parser()
    except Exception as e:
        log.error(f"‚ùå –û—à–∏–±–∫–∞: {e}")

if __name__ == "__main__":
    main()


================================================================================
–§–ê–ô–õ: scripts/hhru_data_export.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/scripts/hhru_data_export.py
================================================================================

#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –≤—ã–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö HeadHunter (HHRU)
"""

import os
import sys
import csv
from datetime import datetime, timedelta
from dotenv import load_dotenv

# –î–æ–±–∞–≤–ª—è–µ–º src –≤ –ø—É—Ç—å Python
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..', 'src'))

load_dotenv()

from tinkoff.invest import Client, CandleInterval
from tinkoff.invest.utils import now
from utils.logger import log

class HHDataExporter:
    def __init__(self):
        self.token = os.getenv('INVEST_TOKEN')
        if not self.token:
            log.error("‚ùå –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env —Ñ–∞–π–ª–µ")
            raise ValueError("–¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω")
        log.info("HeadHunter Data Exporter –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
    
    def find_hhru_instrument(self):
        """–ù–∞—Ö–æ–¥–∏–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç HeadHunter –ø–æ —Ç–∏–∫–µ—Ä—É"""
        with Client(self.token) as client:
            # –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Ç–∏–∫–µ—Ä–æ–≤ HeadHunter
            tickers_to_try = ["HHRU", "HHRS", "HH", "HHR"]
            
            for ticker in tickers_to_try:
                log.info(f"üîç –ò—â–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å —Ç–∏–∫–µ—Ä–æ–º: {ticker}")
                instruments = client.instruments.find_instrument(query=ticker)
                
                for instrument in instruments.instruments:
                    if instrument.ticker.upper() == ticker.upper():
                        log.info(f"‚úÖ –ù–∞–π–¥–µ–Ω –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: {instrument.name} ({instrument.ticker})")
                        log.info(f"   FIGI: {instrument.figi}")
                        log.info(f"   –¢–∏–ø: {instrument.instrument_type}")
                        return instrument
            
            log.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç HeadHunter")
            return None
    
    def get_historical_candles(self, figi, from_date, to_date):
        """–ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ —Å–≤–µ—á–∏ –∑–∞ –ø–µ—Ä–∏–æ–¥"""
        candles_data = []
        
        with Client(self.token) as client:
            # –ü–æ–ª—É—á–∞–µ–º —Å–≤–µ—á–∏ –ø–æ –¥–Ω—è–º
            response = client.market_data.get_candles(
                figi=figi,
                from_=from_date,
                to=to_date,
                interval=CandleInterval.CANDLE_INTERVAL_DAY
            )
            
            for candle in response.candles:
                candles_data.append({
                    'time': candle.time.strftime('%Y-%m-%d %H:%M:%S'),
                    'open': self.quotation_to_float(candle.open),
                    'high': self.quotation_to_float(candle.high),
                    'low': self.quotation_to_float(candle.low),
                    'close': self.quotation_to_float(candle.close),
                    'volume': candle.volume,
                    'is_complete': candle.is_complete
                })
            
            log.info(f"üìä –ü–æ–ª—É—á–µ–Ω–æ {len(candles_data)} —Å–≤–µ—á–µ–π")
            return candles_data
    
    def quotation_to_float(self, quotation):
        """–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º Quotation –≤ float"""
        if hasattr(quotation, 'units') and hasattr(quotation, 'nano'):
            return quotation.units + quotation.nano / 1e9
        return float(quotation) if quotation else 0.0
    
    def export_to_csv(self, candles_data, output_path):
        """–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –≤ CSV"""
        if not candles_data:
            log.error("‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞")
            return False
        
        try:
            with open(output_path, 'w', newline='', encoding='utf-8') as csvfile:
                fieldnames = ['time', 'open', 'high', 'low', 'close', 'volume', 'is_complete']
                writer = csv.DictWriter(csvfile, fieldnames=fieldnames)
                
                writer.writeheader()
                for candle in candles_data:
                    writer.writerow(candle)
            
            log.info(f"üíæ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤: {output_path}")
            return True
            
        except Exception as e:
            log.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ CSV: {e}")
            return False
    
    def run_export(self):
        """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞"""
        log.info("üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º —ç–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö HeadHunter...")
        
        # –ù–∞—Ö–æ–¥–∏–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç
        instrument = self.find_hhru_instrument()
        if not instrument:
            return False
        
        # –ü–µ—Ä–∏–æ–¥ –¥–∞–Ω–Ω—ã—Ö
        from_date = datetime(2024, 1, 1)
        to_date = datetime(2025, 11, 16)
        
        log.info(f"üìÖ –ü–µ—Ä–∏–æ–¥ –¥–∞–Ω–Ω—ã—Ö: {from_date.strftime('%d.%m.%Y')} - {to_date.strftime('%d.%m.%Y')}")
        
        # –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ
        candles_data = self.get_historical_candles(
            instrument.figi, 
            from_date, 
            to_date
        )
        
        if not candles_data:
            log.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ")
            return False
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞ —Ä–∞–±–æ—á–∏–π —Å—Ç–æ–ª
        desktop_path = os.path.join(os.path.expanduser("~"), "Desktop")
        output_filename = f"headhunter_data_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv"
        output_path = os.path.join(desktop_path, output_filename)
        
        success = self.export_to_csv(candles_data, output_path)
        
        if success:
            log.info("‚úÖ –≠–∫—Å–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!")
            print(f"\nüìÅ –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω: {output_path}")
            print(f"üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π: {len(candles_data)}")
        
        return success

def main():
    """–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞"""
    try:
        exporter = HHDataExporter()
        exporter.run_export()
        
    except Exception as e:
        log.error(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
        print("\nüí° –í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:")
        print("   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω –≤ .env —Ñ–∞–π–ª–µ")
        print("   - –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —Ç–æ—Ä–≥–∏ –ø–æ HHRU –∏–¥—É—Ç")
        print("   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É")

if __name__ == "__main__":
    main()


================================================================================
–§–ê–ô–õ: scripts/hhru_data_export_v2.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/scripts/hhru_data_export_v2.py
================================================================================

#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –≤—ã–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö HeadHunter (HHRU) - –ø–µ—Ä–∏–æ–¥ —Å 26.09.2024
"""

import os
import sys
import csv
from datetime import datetime, timedelta
from dotenv import load_dotenv

# –î–æ–±–∞–≤–ª—è–µ–º src –≤ –ø—É—Ç—å Python
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..', 'src'))

load_dotenv()

from tinkoff.invest import Client, CandleInterval
from tinkoff.invest.utils import now
from utils.logger import log

class HHDataExporter:
    def __init__(self):
        self.token = os.getenv('INVEST_TOKEN')
        if not self.token:
            log.error("‚ùå –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env —Ñ–∞–π–ª–µ")
            raise ValueError("–¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω")
        log.info("HeadHunter Data Exporter –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
    
    def find_hhru_instrument(self):
        """–ù–∞—Ö–æ–¥–∏–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç HeadHunter –ø–æ —Ç–∏–∫–µ—Ä—É"""
        with Client(self.token) as client:
            # –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Ç–∏–∫–µ—Ä–æ–≤ HeadHunter
            tickers_to_try = ["HEAD"]
            
            for ticker in tickers_to_try:
                log.info(f"üîç –ò—â–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å —Ç–∏–∫–µ—Ä–æ–º: {ticker}")
                instruments = client.instruments.find_instrument(query=ticker)
                
                for instrument in instruments.instruments:
                    if instrument.ticker.upper() == ticker.upper():
                        log.info(f"‚úÖ –ù–∞–π–¥–µ–Ω –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: {instrument.name} ({instrument.ticker})")
                        log.info(f"   FIGI: {instrument.figi}")
                        log.info(f"   –¢–∏–ø: {instrument.instrument_type}")
                        return instrument
            
            log.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç HeadHunter")
            return None
    
    def get_historical_candles(self, figi, from_date, to_date):
        """–ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ —Å–≤–µ—á–∏ –∑–∞ –ø–µ—Ä–∏–æ–¥"""
        candles_data = []
        
        with Client(self.token) as client:
            # –ü–æ–ª—É—á–∞–µ–º —Å–≤–µ—á–∏ –ø–æ –¥–Ω—è–º
            response = client.market_data.get_candles(
                figi=figi,
                from_=from_date,
                to=to_date,
                interval=CandleInterval.CANDLE_INTERVAL_DAY
            )
            
            for candle in response.candles:
                candles_data.append({
                    'time': candle.time.strftime('%Y-%m-%d %H:%M:%S'),
                    'open': self.quotation_to_float(candle.open),
                    'high': self.quotation_to_float(candle.high),
                    'low': self.quotation_to_float(candle.low),
                    'close': self.quotation_to_float(candle.close),
                    'volume': candle.volume,
                    'is_complete': candle.is_complete
                })
            
            log.info(f"üìä –ü–æ–ª—É—á–µ–Ω–æ {len(candles_data)} —Å–≤–µ—á–µ–π")
            return candles_data
    
    def quotation_to_float(self, quotation):
        """–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º Quotation –≤ float"""
        if hasattr(quotation, 'units') and hasattr(quotation, 'nano'):
            return quotation.units + quotation.nano / 1e9
        return float(quotation) if quotation else 0.0
    
    def export_to_csv(self, candles_data, output_path):
        """–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –≤ CSV"""
        if not candles_data:
            log.error("‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞")
            return False
        
        try:
            with open(output_path, 'w', newline='', encoding='utf-8') as csvfile:
                fieldnames = ['time', 'open', 'high', 'low', 'close', 'volume', 'is_complete']
                writer = csv.DictWriter(csvfile, fieldnames=fieldnames)
                
                writer.writeheader()
                for candle in candles_data:
                    writer.writerow(candle)
            
            log.info(f"üíæ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤: {output_path}")
            return True
            
        except Exception as e:
            log.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ CSV: {e}")
            return False
    
    def run_export(self):
        """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞"""
        log.info("üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º —ç–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö HeadHunter...")
        
        # –ù–∞—Ö–æ–¥–∏–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç
        instrument = self.find_hhru_instrument()
        if not instrument:
            return False
        
        # –ù–û–í–´–ô –ü–ï–†–ò–û–î: —Å 26.09.2024 –ø–æ 16.11.2025
        from_date = datetime(2024, 9, 26)
        to_date = datetime(2025, 11, 16)
        
        log.info(f"üìÖ –ü–µ—Ä–∏–æ–¥ –¥–∞–Ω–Ω—ã—Ö: {from_date.strftime('%d.%m.%Y')} - {to_date.strftime('%d.%m.%Y')}")
        
        # –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ
        candles_data = self.get_historical_candles(
            instrument.figi, 
            from_date, 
            to_date
        )
        
        if not candles_data:
            log.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ")
            return False
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞ —Ä–∞–±–æ—á–∏–π —Å—Ç–æ–ª —Å –§–ò–ö–°–ò–†–û–í–ê–ù–ù–´–ú –∏–º–µ–Ω–µ–º
        desktop_path = os.path.join(os.path.expanduser("~"), "Desktop")
        # –•–ê–†–î–ö–û–î–ò–ú –∏–º—è —Ñ–∞–π–ª–∞
        output_filename = "headhunter_data_sep2024_nov2025.csv"
        output_path = os.path.join(desktop_path, output_filename)
        
        success = self.export_to_csv(candles_data, output_path)
        
        if success:
            log.info("‚úÖ –≠–∫—Å–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!")
            print(f"\nüìÅ –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω: {output_path}")
            print(f"üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π: {len(candles_data)}")
            print(f"üìÖ –ü–µ—Ä–∏–æ–¥: 26.09.2024 - 16.11.2025")
        
        return success

def main():
    """–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞"""
    try:
        exporter = HHDataExporter()
        exporter.run_export()
        
    except Exception as e:
        log.error(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
        print("\nüí° –í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:")
        print("   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω –≤ .env —Ñ–∞–π–ª–µ")
        print("   - –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —Ç–æ—Ä–≥–∏ –ø–æ HHRU –∏–¥—É—Ç")
        print("   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É")

if __name__ == "__main__":
    main()


================================================================================
–§–ê–ô–õ: scripts/scanner_gazp.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/scripts/scanner_gazp.py
================================================================================

#!/usr/bin/env python3
"""
–°–∫—Ä–∏–Ω–µ—Ä —Å—Ç–∞–∫–∞–Ω–∞ –ø–æ –ì–∞–∑–ø—Ä–æ–º—É
–ó–∞–ø—É—Å–∫: python scripts/scanner_gazp.py
"""

import sys
import os
import time

# –î–æ–±–∞–≤–ª—è–µ–º src –≤ –ø—É—Ç—å Python
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..', 'src'))

from data_feed.orderbook import MOEXOrderbook
from utils.logger import log

def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–∫—Ä–∏–Ω–µ—Ä–∞"""
    log.info("üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–Ω–µ—Ä —Å—Ç–∞–∫–∞–Ω–∞...")
    
    client = MOEXOrderbook()
    
    # –°–Ω–∞—á–∞–ª–∞ —Ç–µ—Å—Ç–∏—Ä—É–µ–º –Ω–∞ SBER (–æ–Ω –≤—Å–µ–≥–¥–∞ —Ç–æ—Ä–≥—É–µ—Ç—Å—è)
    log.info("–¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ SBER...")
    test_orderbook = client.get_orderbook("SBER")
    if test_orderbook and ('bids' in test_orderbook or 'asks' in test_orderbook):
        log.info("‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ MOEX —Ä–∞–±–æ—Ç–∞–µ—Ç")
    else:
        log.error("‚ùå –ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ MOEX")
        return
    
    try:
        while True:
            # –û—á–∏—â–∞–µ–º –∫–æ–Ω—Å–æ–ª—å
            os.system('clear' if os.name == 'posix' else 'cls')
            
            print("üéØ –°–ö–†–ò–ù–ï–† –°–¢–ê–ö–ê–ù–ê - –ì–ê–ó–ü–†–û–ú (GAZP)")
            print("–î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C\n")
            
            # –ü–æ–ª—É—á–∞–µ–º –∏ –≤—ã–≤–æ–¥–∏–º —Å—Ç–∞–∫–∞–Ω
            client.print_pretty_orderbook("GAZP")
            
            # –ñ–¥—ë–º 5 —Å–µ–∫—É–Ω–¥ –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            print("\nüîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥...")
            time.sleep(5)
            
    except KeyboardInterrupt:
        log.info("‚èπÔ∏è  –°–∫—Ä–∏–Ω–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
    except Exception as e:
        log.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ —Å–∫—Ä–∏–Ω–µ—Ä–µ: {e}")

if __name__ == "__main__":
    main()


================================================================================
–§–ê–ô–õ: scripts/tinkoff_grpc_client.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/scripts/tinkoff_grpc_client.py
================================================================================

#!/usr/bin/env python3
"""
Tinkoff gRPC –∫–ª–∏–µ–Ω—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞–∫–∞–Ω–∞
–ë—ã—Å—Ç—Ä–µ–µ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ REST –≤–µ—Ä—Å–∏–∏
–ó–∞–ø—É—Å–∫: python scripts/tinkoff_grpc_client.py SBER
"""

import os
import sys
import grpc
import asyncio
from datetime import datetime
from dotenv import load_dotenv

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()

# –î–æ–±–∞–≤–ª—è–µ–º src –≤ –ø—É—Ç—å Python
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..', 'src'))

from utils.logger import log

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º proto-–º–æ–¥—É–ª–∏ Tinkoff
try:
    from tinkoff.invest import AsyncClient
    from tinkoff.invest.schemas import InstrumentStatus, GetOrderBookRequest
    from tinkoff.invest.services import MarketDataStreamManager
    log.info("‚úÖ Tinkoff –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã")
except ImportError as e:
    log.error(f"‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: {e}")
    print("–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –±–∏–±–ª–∏–æ—Ç–µ–∫—É: pip install tinkoff-invest")
    sys.exit(1)

class TinkoffGrpcFastClient:
    """
    –ë—ã—Å—Ç—Ä—ã–π gRPC –∫–ª–∏–µ–Ω—Ç –¥–ª—è Tinkoff API
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã –∏ —Å—Ç—Ä–∏–º–∏–Ω–≥
    """
    
    def __init__(self, token=None):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è gRPC –∫–ª–∏–µ–Ω—Ç–∞
        
        Args:
            token: –¢–æ–∫–µ–Ω Tinkoff Invest API
                  –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω, –±–µ—Ä—ë—Ç—Å—è –∏–∑ .env —Ñ–∞–π–ª–∞
        """
        self.token = token or os.getenv('INVEST_TOKEN')
        if not self.token:
            log.error("‚ùå –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω. –£–∫–∞–∂–∏—Ç–µ –≤ .env —Ñ–∞–π–ª–µ –∏–ª–∏ –ø–µ—Ä–µ–¥–∞–π—Ç–µ –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä")
            raise ValueError("–¢–æ–∫–µ–Ω Tinkoff API –Ω–µ –Ω–∞–π–¥–µ–Ω")
        
        log.info("üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±—ã—Å—Ç—Ä–æ–≥–æ gRPC –∫–ª–∏–µ–Ω—Ç–∞ Tinkoff")
        self._client = None
        
    async def __aenter__(self):
        """–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞"""
        self._client = AsyncClient(self.token)
        await self._client.__aenter__()
        return self
    
    async def __aexit__(self, exc_type, exc_val, exc_tb):
        """–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –∫–ª–∏–µ–Ω—Ç–∞"""
        if self._client:
            await self._client.__aexit__(exc_type, exc_val, exc_tb)
    
    async def find_instrument_by_ticker(self, ticker: str):
        """
        –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –ø–æ —Ç–∏–∫–µ—Ä—É —á–µ—Ä–µ–∑ gRPC
        
        Args:
            ticker: –¢–∏–∫–µ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'SBER')
            
        Returns:
            –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∏–ª–∏ None –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω
        """
        try:
            instruments = await self._client.instruments.find_instrument(query=ticker)
            
            for instrument in instruments.instruments:
                if (instrument.ticker == ticker and 
                    instrument.state == InstrumentStatus.INSTRUMENT_STATUS_BASE):
                    log.info(f"‚úÖ –ù–∞–π–¥–µ–Ω –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: {instrument.name} ({instrument.ticker})")
                    return instrument
            
            log.warning(f"‚ö†Ô∏è –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç {ticker} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö")
            
            # –ü–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ª—é–±–æ–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å —Ç–∞–∫–∏–º —Ç–∏–∫–µ—Ä–æ–º
            for instrument in instruments.instruments:
                if instrument.ticker == ticker:
                    log.info(f"üìù –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –Ω–∞–π–¥–µ–Ω, –Ω–æ —Å—Ç–∞—Ç—É—Å: {instrument.state}")
                    return instrument
                    
            return None
            
        except Exception as e:
            log.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ {ticker}: {e}")
            return None
    
    async def get_orderbook_stream(self, ticker: str, depth: int = 10):
        """
        –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞–∫–∞–Ω –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ —á–µ—Ä–µ–∑ gRPC —Å—Ç—Ä–∏–º
        
        Args:
            ticker: –¢–∏–∫–µ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
            depth: –ì–ª—É–±–∏–Ω–∞ —Å—Ç–∞–∫–∞–Ω–∞
            
        Returns:
            –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å—Ç–∞–∫–∞–Ω–æ–≤
        """
        instrument = await self.find_instrument_by_ticker(ticker)
        if not instrument:
            log.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç {ticker}")
            return
        
        log.info(f"üìä –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å—Ç—Ä–∏–º—É —Å—Ç–∞–∫–∞–Ω–∞ {ticker} (FIGI: {instrument.figi})")
        
        # –°–æ–∑–¥–∞–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä —Å—Ç—Ä–∏–º–∞
        stream_manager = MarketDataStreamManager(self._client)
        
        try:
            async with stream_manager as stream:
                # –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ —Å—Ç–∞–∫–∞–Ω
                await stream.order_book.subscribe(
                    instrument.figi,
                    depth=depth
                )
                
                log.info(f"‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å—Ç–∞–∫–∞–Ω {ticker} –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞")
                print(f"\nüéØ –°–¢–†–ò–ú –°–¢–ê–ö–ê–ù–ê: {ticker}")
                print("–î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C\n")
                
                # –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞–∫–∞–Ω–∞
                async for orderbook in stream:
                    yield self._format_orderbook(orderbook, ticker)
                    
        except asyncio.CancelledError:
            log.info("‚èπÔ∏è –°—Ç—Ä–∏–º –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
        except Exception as e:
            log.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ —Å—Ç—Ä–∏–º–µ: {e}")
    
    async def get_orderbook_snapshot(self, ticker: str, depth: int = 10):
        """
        –ë—ã—Å—Ç—Ä—ã–π –æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å—Ç–∞–∫–∞–Ω–∞ —á–µ—Ä–µ–∑ gRPC
        
        Args:
            ticker: –¢–∏–∫–µ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
            depth: –ì–ª—É–±–∏–Ω–∞ —Å—Ç–∞–∫–∞–Ω–∞
            
        Returns:
            –°–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ —Å—Ç–∞–∫–∞–Ω–∞
        """
        instrument = await self.find_instrument_by_ticker(ticker)
        if not instrument:
            return None
        
        try:
            start_time = datetime.now()
            
            # –ë—ã—Å—Ç—Ä—ã–π gRPC –∑–∞–ø—Ä–æ—Å
            orderbook = await self._client.market_data.get_order_book(
                figi=instrument.figi,
                depth=depth
            )
            
            response_time = (datetime.now() - start_time).total_seconds() * 1000
            
            result = {
                'ticker': ticker,
                'instrument': instrument,
                'orderbook': orderbook,
                'timestamp': datetime.now(),
                'response_time_ms': response_time,
                'source': 'gRPC'
            }
            
            log.info(f"üìä –°—Ç–∞–∫–∞–Ω {ticker} –ø–æ–ª—É—á–µ–Ω –∑–∞ {response_time:.1f} –º—Å")
            return result
            
        except Exception as e:
            log.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞–∫–∞–Ω–∞ {ticker}: {e}")
            return None
    
    def _format_orderbook(self, orderbook_data, ticker: str):
        """
        –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ —Å—Ç–∞–∫–∞–Ω–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
        
        Returns:
            –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        """
        if not orderbook_data or not hasattr(orderbook_data, 'orderbook'):
            return None
        
        orderbook = orderbook_data.orderbook
        
        # –°–æ–±–∏—Ä–∞–µ–º –±–∏–¥—ã –∏ –∞—Å–∫–∏
        bids = []
        asks = []
        
        if orderbook.bids:
            for bid in orderbook.bids[:5]:  # –¢–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 5
                price = self._quotation_to_float(bid.price)
                quantity = bid.quantity
                bids.append((price, quantity))
        
        if orderbook.asks:
            for ask in orderbook.asks[:5]:
                price = self._quotation_to_float(ask.price)
                quantity = ask.quantity
                asks.append((price, quantity))
        
        return {
            'ticker': ticker,
            'timestamp': datetime.now(),
            'bids': bids,
            'asks': asks,
            'best_bid': self._quotation_to_float(orderbook.best_bid_price) if orderbook.best_bid_price else None,
            'best_ask': self._quotation_to_float(orderbook.best_ask_price) if orderbook.best_ask_price else None,
            'depth': len(orderbook.bids) + len(orderbook.asks)
        }
    
    def _quotation_to_float(self, quotation):
        """–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç Quotation –≤ float"""
        if hasattr(quotation, 'units') and hasattr(quotation, 'nano'):
            return quotation.units + quotation.nano / 1e9
        return float(quotation) if quotation else 0.0
    
    def print_pretty_orderbook(self, data):
        """
        –ö—Ä–∞—Å–∏–≤–æ –ø–µ—á–∞—Ç–∞–µ—Ç —Å—Ç–∞–∫–∞–Ω
        
        Args:
            data: –î–∞–Ω–Ω—ã–µ —Å—Ç–∞–∫–∞–Ω–∞ –∏–∑ get_orderbook_snapshot
        """
        if not data:
            print(f"‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö —Å—Ç–∞–∫–∞–Ω–∞")
            return
        
        orderbook = data['orderbook']
        instrument = data['instrument']
        
        print(f"\n{'='*60}")
        print(f"üìä –°–¢–ê–ö–ê–ù {data['ticker']} ({instrument.name})")
        print(f"‚è∞ {data['timestamp'].strftime('%H:%M:%S')} | üì° {data['source']}")
        print(f"‚ö° –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: {data.get('response_time_ms', 0):.1f} –º—Å")
        print(f"{'='*60}")
        
        # –ê—Å–∫–∏ (–ø—Ä–æ–¥–∞–∂–∞) - —Å–≤–µ—Ä—Ö—É
        if orderbook.asks:
            print("üí∞ –ü–†–û–î–ê–ñ–ê (asks):")
            for ask in orderbook.asks[:5]:  # –ü–µ—Ä–≤—ã–µ 5 —É—Ä–æ–≤–Ω–µ–π
                price = self._quotation_to_float(ask.price)
                quantity = ask.quantity
                print(f"  {price:10.2f} | {quantity:6} –ª–æ—Ç–æ–≤")
        else:
            print("üí∞ –ü–†–û–î–ê–ñ–ê: –ø—É—Å—Ç–æ")
        
        print(f"{'-'*30}")
        
        # –ë–∏–¥—ã (–ø–æ–∫—É–ø–∫–∞) - —Å–Ω–∏–∑—É
        if orderbook.bids:
            print("üõí –ü–û–ö–£–ü–ö–ê (bids):")
            for bid in orderbook.bids[:5]:
                price = self._quotation_to_float(bid.price)
                quantity = bid.quantity
                print(f"  {price:10.2f} | {quantity:6} –ª–æ—Ç–æ–≤")
        else:
            print("üõí –ü–û–ö–£–ü–ö–ê: –ø—É—Å—Ç–æ")
        
        print(f"{'='*60}")
        
        # –õ—É—á—à–∏–µ —Ü–µ–Ω—ã
        if orderbook.best_bid_price and orderbook.best_ask_price:
            spread = self._quotation_to_float(orderbook.best_ask_price) - self._quotation_to_float(orderbook.best_bid_price)
            spread_percent = (spread / self._quotation_to_float(orderbook.best_bid_price)) * 100
            print(f"üíé –õ—É—á—à–∏–π —Å–ø—Ä–æ—Å:   {self._quotation_to_float(orderbook.best_bid_price):.2f}")
            print(f"üíé –õ—É—á—à–µ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ: {self._quotation_to_float(orderbook.best_ask_price):.2f}")
            print(f"üìè –°–ø—Ä–µ–¥: {spread:.2f} ({spread_percent:.2f}%)")
        print(f"{'='*60}")

# –°–ò–ù–•–†–û–ù–ù–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ö–û–ú–ê–ù–î–ù–û–ô –°–¢–†–û–ö–ò
# ==========================================

async def get_orderbook_async(ticker="SBER", depth=5):
    """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞–∫–∞–Ω–∞"""
    async with TinkoffGrpcFastClient() as client:
        data = await client.get_orderbook_snapshot(ticker, depth)
        if data:
            client.print_pretty_orderbook(data)
        else:
            print(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞–∫–∞–Ω {ticker}")

async def stream_orderbook_async(ticker="SBER", depth=5, limit=10):
    """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π —Å—Ç—Ä–∏–º —Å—Ç–∞–∫–∞–Ω–∞"""
    client = TinkoffGrpcFastClient()
    async with client as grpc_client:
        count = 0
        try:
            async for orderbook in grpc_client.get_orderbook_stream(ticker, depth):
                if orderbook:
                    print(f"\nüìà –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ #{count+1} - {ticker}")
                    print(f"‚è∞ {orderbook['timestamp'].strftime('%H:%M:%S.%f')[:-3]}")
                    
                    if orderbook['asks']:
                        print("üí∞ –ü—Ä–æ–¥–∞–∂–∞:")
                        for price, qty in orderbook['asks']:
                            print(f"  {price:10.2f} | {qty:6} –ª–æ—Ç–æ–≤")
                    
                    if orderbook['bids']:
                        print("üõí –ü–æ–∫—É–ø–∫–∞:")
                        for price, qty in orderbook['bids']:
                            print(f"  {price:10.2f} | {qty:6} –ª–æ—Ç–æ–≤")
                    
                    if orderbook['best_bid'] and orderbook['best_ask']:
                        spread = orderbook['best_ask'] - orderbook['best_bid']
                        print(f"üìè –°–ø—Ä–µ–¥: {spread:.2f}")
                    
                    count += 1
                    if limit and count >= limit:
                        print(f"\n‚úÖ –ü–æ–ª—É—á–µ–Ω–æ {limit} –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π")
                        break
                        
        except KeyboardInterrupt:
            print(f"\n‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º. –ü–æ–ª—É—á–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π: {count}")

# –°–ò–ù–•–†–û–ù–ù–´–ï –û–ë–ï–†–¢–ö–ò –î–õ–Ø –ó–ê–ü–£–°–ö–ê –ò–ó –ö–û–ú–ê–ù–î–ù–û–ô –°–¢–†–û–ö–ò
# ====================================================

def get_orderbook(ticker="SBER", depth=5):
    """–°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±–µ—Ä—Ç–∫–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞–∫–∞–Ω–∞"""
    try:
        asyncio.run(get_orderbook_async(ticker, depth))
    except KeyboardInterrupt:
        print("\n‚èπÔ∏è –û–ø–µ—Ä–∞—Ü–∏—è –ø—Ä–µ—Ä–≤–∞–Ω–∞")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")

def stream_orderbook(ticker="SBER", depth=5, limit=None):
    """–°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±–µ—Ä—Ç–∫–∞ –¥–ª—è —Å—Ç—Ä–∏–º–∞ —Å—Ç–∞–∫–∞–Ω–∞"""
    try:
        asyncio.run(stream_orderbook_async(ticker, depth, limit))
    except KeyboardInterrupt:
        print("\n‚èπÔ∏è –ü–æ—Ç–æ–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –≤ –ø–æ—Ç–æ–∫–µ: {e}")

def test_connection():
    """–¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ gRPC"""
    print("üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º gRPC –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Tinkoff...")
    try:
        asyncio.run(test_connection_async())
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")

async def test_connection_async():
    """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è"""
    async with TinkoffGrpcFastClient() as client:
        print("‚úÖ gRPC –∫–ª–∏–µ–Ω—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–∏—Å–∫ SBER
        instrument = await client.find_instrument_by_ticker("SBER")
        if instrument:
            print(f"‚úÖ –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –Ω–∞–π–¥–µ–Ω: {instrument.name}")
            return True
        else:
            print("‚ùå –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω")
            return False

# –¢–û–ß–ö–ê –í–•–û–î–ê
# ===========

def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""
    if len(sys.argv) < 2:
        print("""
üì° Tinkoff gRPC Client - –ë—ã—Å—Ç—Ä–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞–∫–∞–Ω–∞
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
  python scripts/tinkoff_grpc_client.py <–∫–æ–º–∞–Ω–¥–∞> [–ø–∞—Ä–∞–º–µ—Ç—Ä—ã]

–ö–æ–º–∞–Ω–¥—ã:
  get <—Ç–∏–∫–µ—Ä> [–≥–ª—É–±–∏–Ω–∞]     - –û–¥–Ω–æ–∫—Ä–∞—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å—Ç–∞–∫–∞–Ω–∞
  stream <—Ç–∏–∫–µ—Ä> [–≥–ª—É–±–∏–Ω–∞]  - –ü–æ—Ç–æ–∫–æ–≤—ã–π —Å—Ç–∞–∫–∞–Ω (Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏)
  test                      - –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
  
–ü—Ä–∏–º–µ—Ä—ã:
  python scripts/tinkoff_grpc_client.py get SBER 10
  python scripts/tinkoff_grpc_client.py stream GAZP 5
  python scripts/tinkoff_grpc_client.py test
        """)
        return
    
    command = sys.argv[1].lower()
    
    if command == "get":
        ticker = sys.argv[2] if len(sys.argv) > 2 else "SBER"
        depth = int(sys.argv[3]) if len(sys.argv) > 3 else 5
        get_orderbook(ticker, depth)
    
    elif command == "stream":
        ticker = sys.argv[2] if len(sys.argv) > 2 else "SBER"
        depth = int(sys.argv[3]) if len(sys.argv) > 3 else 5
        limit = int(sys.argv[4]) if len(sys.argv) > 4 else None
        stream_orderbook(ticker, depth, limit)
    
    elif command == "test":
        test_connection()
    
    else:
        print(f"‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: {command}")
        print("–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã: get, stream, test")

if __name__ == "__main__":
    main()


================================================================================
–§–ê–ô–õ: scripts/tinkoff_grpc_client_fixed.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/scripts/tinkoff_grpc_client_fixed.py
================================================================================

#!/usr/bin/env python3
"""
Tinkoff gRPC –∫–ª–∏–µ–Ω—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞–∫–∞–Ω–∞ - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø 2
"""

import os
import sys
import asyncio
from datetime import datetime
from dotenv import load_dotenv

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()

# –î–æ–±–∞–≤–ª—è–µ–º src –≤ –ø—É—Ç—å Python
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..', 'src'))

from utils.logger import log

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º proto-–º–æ–¥—É–ª–∏ Tinkoff
try:
    from tinkoff.invest import Client, AsyncClient
    from tinkoff.invest.schemas import InstrumentStatus, InstrumentIdType
    log.info("‚úÖ Tinkoff –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã")
except ImportError as e:
    log.error(f"‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: {e}")
    sys.exit(1)

class TinkoffGrpcFastClient:
    """
    –ë—ã—Å—Ç—Ä—ã–π gRPC –∫–ª–∏–µ–Ω—Ç –¥–ª—è Tinkoff API
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã –∏ —Å—Ç—Ä–∏–º–∏–Ω–≥
    """
    
    def __init__(self, token=None):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è gRPC –∫–ª–∏–µ–Ω—Ç–∞
        """
        self.token = token or os.getenv('INVEST_TOKEN')
        if not self.token:
            log.error("‚ùå –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω. –£–∫–∞–∂–∏—Ç–µ –≤ .env —Ñ–∞–π–ª–µ")
            raise ValueError("–¢–æ–∫–µ–Ω Tinkoff API –Ω–µ –Ω–∞–π–¥–µ–Ω")
        
        log.info("üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±—ã—Å—Ç—Ä–æ–≥–æ gRPC –∫–ª–∏–µ–Ω—Ç–∞ Tinkoff")
    
    def find_instrument_by_ticker_sync(self, ticker: str):
        """
        –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ (–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –í–ê–†–ò–ê–ù–¢)
        –ö–ª—é—á–µ–≤–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –ø–æ–ª—É—á–∞–µ–º –ø–æ–ª–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —á–µ—Ä–µ–∑ get_instrument_by()
        """
        try:
            with Client(self.token) as client:
                # 1. –°–Ω–∞—á–∞–ª–∞ –Ω–∞—Ö–æ–¥–∏–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —á–µ—Ä–µ–∑ find_instrument
                found_instruments = client.instruments.find_instrument(query=ticker)
                
                if not found_instruments.instruments:
                    log.error(f"‚ùå –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å —Ç–∏–∫–µ—Ä–æ–º '{ticker}' –Ω–µ –Ω–∞–π–¥–µ–Ω")
                    return None
                
                # 2. –ò—â–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ø–æ —Ç–∏–∫–µ—Ä—É
                target_instrument = None
                for instrument in found_instruments.instruments:
                    if instrument.ticker == ticker:
                        target_instrument = instrument
                        log.info(f"üîç –ù–∞–π–¥–µ–Ω —Ç–∏–∫–µ—Ä '{ticker}', –ø–æ–ª—É—á–∞–µ–º –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ...")
                        break
                
                if not target_instrument:
                    log.error(f"‚ùå –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –¥–ª—è —Ç–∏–∫–µ—Ä–∞ '{ticker}' –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")
                    return None
                
                # 3. –ü–æ–ª—É—á–∞–µ–º –ü–û–õ–ù–´–ô –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —á–µ—Ä–µ–∑ get_instrument_by
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º FIGI, –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ uid
                if hasattr(target_instrument, 'figi') and target_instrument.figi:
                    full_instrument = client.instruments.get_instrument_by(
                        id_type=InstrumentIdType.INSTRUMENT_ID_TYPE_FIGI,
                        id=target_instrument.figi
                    )
                elif hasattr(target_instrument, 'uid') and target_instrument.uid:
                    full_instrument = client.instruments.get_instrument_by(
                        id_type=InstrumentIdType.INSTRUMENT_ID_TYPE_UID,
                        id=target_instrument.uid
                    )
                else:
                    log.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –¥–ª—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ '{ticker}'")
                    return None
                
                # 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∞–∫—Ç–∏–≤–µ–Ω
                if full_instrument.instrument.state == InstrumentStatus.INSTRUMENT_STATUS_BASE:
                    log.info(f"‚úÖ –ù–∞–π–¥–µ–Ω –∞–∫—Ç–∏–≤–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: {full_instrument.instrument.name} ({full_instrument.instrument.ticker})")
                    return full_instrument.instrument
                else:
                    log.warning(f"‚ö†Ô∏è  –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –Ω–∞–π–¥–µ–Ω, –Ω–æ –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω: {full_instrument.instrument.name}, —Å—Ç–∞—Ç—É—Å: {full_instrument.instrument.state}")
                    return full_instrument.instrument
                
        except Exception as e:
            log.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ '{ticker}': {e}")
            import traceback
            log.error(f"–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏: {traceback.format_exc()}")
            return None
    
    def get_orderbook_snapshot_sync(self, ticker: str, depth: int = 5):
        """
        –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å—Ç–∞–∫–∞–Ω–∞ (–æ—Å–Ω–æ–≤–Ω–æ–π —Ä–∞–±–æ—á–∏–π –º–µ—Ç–æ–¥)
        """
        log.info(f"üìä –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å—Ç–∞–∫–∞–Ω –¥–ª—è '{ticker}'...")
        instrument = self.find_instrument_by_ticker_sync(ticker)
        
        if not instrument:
            log.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç '{ticker}' –¥–ª—è —Å—Ç–∞–∫–∞–Ω–∞")
            return None
        
        try:
            start_time = datetime.now()
            
            with Client(self.token) as client:
                # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞–∫–∞–Ω
                orderbook = client.market_data.get_order_book(
                    figi=instrument.figi,
                    depth=depth
                )
            
            response_time = (datetime.now() - start_time).total_seconds() * 1000
            
            result = {
                'ticker': ticker,
                'instrument': instrument,
                'orderbook': orderbook,
                'timestamp': datetime.now(),
                'response_time_ms': response_time,
                'source': 'gRPC (sync)'
            }
            
            log.info(f"‚úÖ –°—Ç–∞–∫–∞–Ω '{ticker}' –ø–æ–ª—É—á–µ–Ω –∑–∞ {response_time:.1f} –º—Å")
            return result
            
        except Exception as e:
            log.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞–∫–∞–Ω–∞ '{ticker}': {e}")
            return None
    
    def _quotation_to_float(self, quotation):
        """–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç Quotation –≤ float"""
        if hasattr(quotation, 'units') and hasattr(quotation, 'nano'):
            return quotation.units + quotation.nano / 1e9
        return float(quotation) if quotation else 0.0
    
    def print_pretty_orderbook(self, data):
        """
        –ö—Ä–∞—Å–∏–≤–æ –ø–µ—á–∞—Ç–∞–µ—Ç —Å—Ç–∞–∫–∞–Ω
        """
        if not data:
            print(f"‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö —Å—Ç–∞–∫–∞–Ω–∞")
            return
        
        orderbook = data['orderbook']
        instrument = data['instrument']
        
        print(f"\n{'='*60}")
        print(f"üìä –°–¢–ê–ö–ê–ù {data['ticker']} ({instrument.name})")
        print(f"‚è∞ {data['timestamp'].strftime('%H:%M:%S')} | üì° {data['source']}")
        print(f"‚ö° –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: {data.get('response_time_ms', 0):.1f} –º—Å")
        print(f"{'='*60}")
        
        # –ê—Å–∫–∏ (–ø—Ä–æ–¥–∞–∂–∞) - —Å–≤–µ—Ä—Ö—É
        if orderbook.asks:
            print("üí∞ –ü–†–û–î–ê–ñ–ê (asks):")
            for ask in orderbook.asks[:5]:
                price = self._quotation_to_float(ask.price)
                quantity = ask.quantity
                print(f"  {price:10.2f} | {quantity:6} –ª–æ—Ç–æ–≤")
        else:
            print("üí∞ –ü–†–û–î–ê–ñ–ê: –ø—É—Å—Ç–æ")
        
        print(f"{'-'*30}")
        
        # –ë–∏–¥—ã (–ø–æ–∫—É–ø–∫–∞) - —Å–Ω–∏–∑—É
        if orderbook.bids:
            print("üõí –ü–û–ö–£–ü–ö–ê (bids):")
            for bid in orderbook.bids[:5]:
                price = self._quotation_to_float(bid.price)
                quantity = bid.quantity
                print(f"  {price:10.2f} | {quantity:6} –ª–æ—Ç–æ–≤")
        else:
            print("üõí –ü–û–ö–£–ü–ö–ê: –ø—É—Å—Ç–æ")
        
        print(f"{'='*60}")
        
        # –õ—É—á—à–∏–µ —Ü–µ–Ω—ã
        if orderbook.best_bid_price and orderbook.best_ask_price:
            spread = self._quotation_to_float(orderbook.best_ask_price) - self._quotation_to_float(orderbook.best_bid_price)
            spread_percent = (spread / self._quotation_to_float(orderbook.best_bid_price)) * 100
            print(f"üíé –õ—É—á—à–∏–π —Å–ø—Ä–æ—Å:   {self._quotation_to_float(orderbook.best_bid_price):.2f}")
            print(f"üíé –õ—É—á—à–µ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ: {self._quotation_to_float(orderbook.best_ask_price):.2f}")
            print(f"üìè –°–ø—Ä–µ–¥: {spread:.2f} ({spread_percent:.2f}%)")
        print(f"{'='*60}")

# –°–ò–ù–•–†–û–ù–ù–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ö–û–ú–ê–ù–î–ù–û–ô –°–¢–†–û–ö–ò
# ==========================================

def get_orderbook_sync(ticker="SBER", depth=5):
    """–°–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞–∫–∞–Ω–∞"""
    client = TinkoffGrpcFastClient()
    data = client.get_orderbook_snapshot_sync(ticker, depth)
    if data:
        client.print_pretty_orderbook(data)
    else:
        print(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞–∫–∞–Ω {ticker}")

def test_connection_sync(ticker="SBER"):
    """–°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è"""
    print(f"üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Tinkoff –¥–ª—è —Ç–∏–∫–µ—Ä–∞ '{ticker}'...")
    try:
        client = TinkoffGrpcFastClient()
        instrument = client.find_instrument_by_ticker_sync(ticker)
        if instrument:
            print(f"‚úÖ –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –Ω–∞–π–¥–µ–Ω!")
            print(f"   –ù–∞–∑–≤–∞–Ω–∏–µ: {instrument.name}")
            print(f"   –¢–∏–∫–µ—Ä: {instrument.ticker}")
            print(f"   FIGI: {instrument.figi}")
            print(f"   –°—Ç–∞—Ç—É—Å: {instrument.state}")
            print(f"   –õ–æ—Ç: {instrument.lot}")
            return True
        else:
            print(f"‚ùå –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç '{ticker}' –Ω–µ –Ω–∞–π–¥–µ–Ω")
            return False
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
        return False

def simple_test():
    """–ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ API"""
    print("üß™ –ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç API...")
    try:
        from tinkoff.invest import Client
        from tinkoff.invest.schemas import InstrumentIdType
        from dotenv import load_dotenv
        import os
        
        load_dotenv()
        token = os.getenv('INVEST_TOKEN')
        
        with Client(token) as client:
            # –ò—â–µ–º SBER
            instruments = client.instruments.find_instrument(query="SBER")
            print(f"üîç –ù–∞–π–¥–µ–Ω–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤: {len(instruments.instruments)}")
            
            for i, instr in enumerate(instruments.instruments[:3]):
                print(f"\n–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç {i+1}:")
                print(f"  –¢–∏–ø: {type(instr)}")
                print(f"  –¢–∏–∫–µ—Ä: {instr.ticker}")
                print(f"  –ù–∞–∑–≤–∞–Ω–∏–µ: {instr.name}")
                print(f"  –ê—Ç—Ä–∏–±—É—Ç—ã: {[attr for attr in dir(instr) if not attr.startswith('_')]}")
                
                # –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –µ—Å–ª–∏ –µ—Å—Ç—å FIGI
                if hasattr(instr, 'figi') and instr.figi:
                    try:
                        full = client.instruments.get_instrument_by(
                            id_type=InstrumentIdType.INSTRUMENT_ID_TYPE_FIGI,
                            id=instr.figi
                        )
                        print(f"  ‚úÖ –ü–æ–ª–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø–æ–ª—É—á–µ–Ω!")
                        print(f"     –°—Ç–∞—Ç—É—Å: {full.instrument.state}")
                    except Exception as e:
                        print(f"  ‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞: {e}")
        
        return True
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ—Å—Ç–æ–≥–æ —Ç–µ—Å—Ç–∞: {e}")
        return False

# –¢–û–ß–ö–ê –í–•–û–î–ê
# ===========

def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""
    if len(sys.argv) < 2:
        print("""
üì° Tinkoff gRPC Client v2 - –ë—ã—Å—Ç—Ä–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞–∫–∞–Ω–∞
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
  python scripts/tinkoff_grpc_client_fixed.py <–∫–æ–º–∞–Ω–¥–∞> [—Ç–∏–∫–µ—Ä] [–≥–ª—É–±–∏–Ω–∞]

–ö–æ–º–∞–Ω–¥—ã:
  test [—Ç–∏–∫–µ—Ä]       - –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏ –ø–æ–∏—Å–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
  get [—Ç–∏–∫–µ—Ä] [–≥–ª—É–±] - –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞–∫–∞–Ω (–≥–ª—É–±–∏–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 5)
  simple             - –ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç API –Ω–∞–ø—Ä—è–º—É—é
  
–ü—Ä–∏–º–µ—Ä—ã:
  python scripts/tinkoff_grpc_client_fixed.py test SBER
  python scripts/tinkoff_grpc_client_fixed.py get GAZP 10
  python scripts/tinkoff_grpc_client_fixed.py simple
        """)
        return
    
    command = sys.argv[1].lower()
    
    if command == "test":
        ticker = sys.argv[2] if len(sys.argv) > 2 else "SBER"
        test_connection_sync(ticker)
    
    elif command == "get":
        ticker = sys.argv[2] if len(sys.argv) > 2 else "SBER"
        depth = int(sys.argv[3]) if len(sys.argv) > 3 else 5
        get_orderbook_sync(ticker, depth)
    
    elif command == "simple":
        simple_test()
    
    else:
        print(f"‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: {command}")

if __name__ == "__main__":
    main()


================================================================================
–§–ê–ô–õ: scripts/tinkoff_scanner.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/scripts/tinkoff_scanner.py
================================================================================

#!/usr/bin/env python3
"""
–°–∫—Ä–∏–Ω–µ—Ä —Å—Ç–∞–∫–∞–Ω–æ–≤ –Ω–∞ Tinkoff API (–±–æ–µ–≤–æ–π –∫–æ–Ω—Ç—É—Ä)
"""

import sys
import os
import time
from dotenv import load_dotenv

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env —Ñ–∞–π–ª–∞
load_dotenv()

# –î–æ–±–∞–≤–ª—è–µ–º src –≤ –ø—É—Ç—å Python
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..', 'src'))

from data_feed.tinkoff_client_simple import TinkoffAPIClientSimple
from utils.logger import log

def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–∫—Ä–∏–Ω–µ—Ä–∞"""
    log.info("üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–Ω–µ—Ä –Ω–∞ Tinkoff API (–ë–û–ï–í–û–ô –ö–û–ù–¢–£–†)...")
    
    try:
        client = TinkoffAPIClientSimple()
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
        test_data = client.get_orderbook("SBER")
        if test_data:
            log.info("‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Tinkoff API —Ä–∞–±–æ—Ç–∞–µ—Ç")
        else:
            log.error("‚ùå –ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ Tinkoff API")
            return
    
    except Exception as e:
        log.error(f"‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: {e}")
        return
    
    # –°–ø–∏—Å–æ–∫ —Ç–∏–∫–µ—Ä–æ–≤ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
    tickers = ["ABIO"]
    
    try:
        while True:
            # –û—á–∏—â–∞–µ–º –∫–æ–Ω—Å–æ–ª—å
            os.system('clear' if os.name == 'posix' else 'cls')
            
            print("üéØ –°–ö–†–ò–ù–ï–† –°–¢–ê–ö–ê–ù–û–í - TINKOFF API (–ë–û–ï–í–û–ô –ö–û–ù–¢–£–†)")
            print("–î–ê–ù–ù–´–ï –†–ï–ê–õ–¨–ù–´–ï - –ë–£–î–¨–¢–ï –û–°–¢–û–†–û–ñ–ù–´!")
            print("–î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C\n")
            
            for ticker in tickers:
                client.print_pretty_orderbook(ticker, depth=3)
                print()
            
            print("üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥...")
            time.sleep(1)
            
    except KeyboardInterrupt:
        log.info("‚èπÔ∏è  –°–∫—Ä–∏–Ω–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
    except Exception as e:
        log.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ —Å–∫—Ä–∏–Ω–µ—Ä–µ: {e}")

if __name__ == "__main__":
    main()


================================================================================
–§–ê–ô–õ: src/__init__.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/src/__init__.py
================================================================================



================================================================================
–§–ê–ô–õ: src/data_feed/__init__.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/src/data_feed/__init__.py
================================================================================



================================================================================
–§–ê–ô–õ: src/data_feed/moex_client.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/src/data_feed/moex_client.py
================================================================================

import requests
import pandas as pd
from src.utils.logger import log

class MOEXClient:
    """
    –ö–ª–∏–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å API –ú–æ—Å–∫–æ–≤—Å–∫–æ–π –±–∏—Ä–∂–∏
    """
    
    def __init__(self):
        self.base_url = "https://iss.moex.com/iss"
        self.session = requests.Session()
        log.info("MOEX –∫–ª–∏–µ–Ω—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
    
    def get_security_info(self, ticker: str) -> dict:
        """–ü–æ–ª—É—á–∏—Ç—å –±–∞–∑–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±—É–º–∞–≥–µ"""
        url = f"{self.base_url}/securities/{ticker}.json"
        try:
            response = self.session.get(url)
            response.raise_for_status()
            data = response.json()
            log.info(f"–î–∞–Ω–Ω—ã–µ –ø–æ {ticker} –ø–æ–ª—É—á–µ–Ω—ã")
            return data
        except Exception as e:
            log.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ {ticker}: {e}")
            return {}
    
    def get_current_market_data(self, ticker: str) -> dict:
        """–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–µ —Ä—ã–Ω–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ"""
        url = f"{self.base_url}/engines/stock/markets/shares/boards/TQBR/securities/{ticker}.json"
        try:
            response = self.session.get(url)
            data = response.json()
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ä—ã–Ω–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            market_data = data.get('marketdata', {}).get('data', [])
            if market_data:
                # –ë–∞–∑–æ–≤—ã–µ –ø–æ–ª—è –∏–∑ —Ä—ã–Ω–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                last_trade = market_data[0]
                return {
                    'last_price': last_trade[12],  # LAST
                    'change': last_trade[13],      # CHANGE
                    'volume': last_trade[9]        # VOLUME
                }
            return {}
        except Exception as e:
            log.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä—ã–Ω–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö {ticker}: {e}")
            return {}

if __name__ == "__main__":
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –∫–ª–∏–µ–Ω—Ç
    client = MOEXClient()
    
    # –¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ SBER
    sber_info = client.get_security_info("SBER")
    if sber_info:
        log.info("‚úÖ MOEX –∫–ª–∏–µ–Ω—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç - –¥–∞–Ω–Ω—ã–µ SBER –ø–æ–ª—É—á–µ–Ω—ã")
    
    sber_market = client.get_current_market_data("SBER")
    if sber_market:
        log.info(f"‚úÖ –†—ã–Ω–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ SBER: {sber_market}")


================================================================================
–§–ê–ô–õ: src/data_feed/orderbook.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/src/data_feed/orderbook.py
================================================================================

import requests
import pandas as pd
import sys
import os

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ utils
current_dir = os.path.dirname(os.path.abspath(__file__))
src_root = os.path.dirname(current_dir)
sys.path.insert(0, src_root)

from utils.logger import log

class MOEXOrderbook:
    """–ö–ª–∏–µ–Ω—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞–∫–∞–Ω–∞ –∑–∞—è–≤–æ–∫ —Å MOEX"""
    
    def __init__(self):
        self.base_url = "https://iss.moex.com/iss"
        self.session = requests.Session()
        log.info("MOEX Orderbook –∫–ª–∏–µ–Ω—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
    
    def get_orderbook(self, ticker: str) -> dict:
        """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞–∫–∞–Ω –∑–∞—è–≤–æ–∫ –ø–æ —Ç–∏–∫–µ—Ä—É"""
        url = f"{self.base_url}/engines/stock/markets/shares/securities/{ticker}/orderbook.json"
        
        try:
            response = self.session.get(url)
            response.raise_for_status()
            data = response.json()
            
            # –ü–∞—Ä—Å–∏–º —Å—Ç–∞–∫–∞–Ω
            orderbook_data = self._parse_orderbook(data)
            log.info(f"–°—Ç–∞–∫–∞–Ω –ø–æ {ticker} –ø–æ–ª—É—á–µ–Ω")
            return orderbook_data
            
        except Exception as e:
            log.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞–∫–∞–Ω–∞ {ticker}: {e}")
            log.error(f"URL –±—ã–ª: {url}")
            return {}
    
    def _parse_orderbook(self, data: dict) -> dict:
        """–ü–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ —Å—Ç–∞–∫–∞–Ω–∞"""
        result = {}
        
        # –ü–∞—Ä—Å–∏–º –ø–æ–∫—É–ø–∫–∏ (bids)
        if 'orderbook' in data and 'bids' in data['orderbook']:
            bids_data = data['orderbook']['bids']
            if bids_data:
                result['bids'] = pd.DataFrame(bids_data)
        
        # –ü–∞—Ä—Å–∏–º –ø—Ä–æ–¥–∞–∂–∏ (asks)  
        if 'orderbook' in data and 'asks' in data['orderbook']:
            asks_data = data['orderbook']['asks']
            if asks_data:
                result['asks'] = pd.DataFrame(asks_data)
        
        return result
    
    def print_pretty_orderbook(self, ticker: str, levels: int = 5):
        """–ö—Ä–∞—Å–∏–≤–æ –≤—ã–≤–æ–¥–∏–º —Å—Ç–∞–∫–∞–Ω"""
        orderbook = self.get_orderbook(ticker)
        
        if not orderbook or ('bids' not in orderbook and 'asks' not in orderbook):
            print(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞–∫–∞–Ω –¥–ª—è {ticker}")
            print("‚ÑπÔ∏è  –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:")
            print("   - –¢–æ—Ä–≥–∏ –ø–æ —ç—Ç–æ–π –±—É–º–∞–≥–µ –Ω–µ –∏–¥—É—Ç")
            print("   - –ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ MOEX")
            print("   - –¢–∏–∫–µ—Ä —É–∫–∞–∑–∞–Ω –Ω–µ–≤–µ—Ä–Ω–æ")
            return
        
        print(f"\nüìä –°—Ç–∞–∫–∞–Ω –ø–æ {ticker}:")
        print("=" * 50)
        
        # –í—ã–≤–æ–¥–∏–º –ø—Ä–æ–¥–∞–∂–∏ (asks) - —Å–≤–µ—Ä—Ö—É
        if 'asks' in orderbook and not orderbook['asks'].empty:
            print("üí∞ –ü–†–û–î–ê–ñ–ò (asks):")
            asks_df = orderbook['asks'].head(levels)
            for _, row in asks_df.iterrows():
                price = row[0]  # –¶–µ–Ω–∞
                quantity = row[1]  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ
                print(f"   {price:8.2f} | {quantity:6} –ª–æ—Ç–æ–≤")
        
        print("-" * 30)
        
        # –í—ã–≤–æ–¥–∏–º –ø–æ–∫—É–ø–∫–∏ (bids) - —Å–Ω–∏–∑—É
        if 'bids' in orderbook and not orderbook['bids'].empty:
            print("üõí –ü–û–ö–£–ü–ö–ò (bids):")
            bids_df = orderbook['bids'].head(levels)
            for _, row in bids_df.iterrows():
                price = row[0]  # –¶–µ–Ω–∞
                quantity = row[1]  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ
                print(f"   {price:8.2f} | {quantity:6} –ª–æ—Ç–æ–≤")
        
        print("=" * 50)

if __name__ == "__main__":
    client = MOEXOrderbook()
    client.print_pretty_orderbook("SBER")


================================================================================
–§–ê–ô–õ: src/data_feed/tinkoff_client.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/src/data_feed/tinkoff_client.py
================================================================================

import os
import sys
from datetime import datetime
from dotenv import load_dotenv

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env
load_dotenv()

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ utils
current_dir = os.path.dirname(os.path.abspath(__file__))
src_root = os.path.dirname(current_dir)
sys.path.insert(0, src_root)

from tinkoff.invest import Client, GetOrderBookRequest
from tinkoff.invest.schemas import InstrumentStatus
from utils.logger import log

class TinkoffAPIClient:
    """–ö–ª–∏–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Tinkoff Invest API (–±–æ–µ–≤–æ–π –∫–æ–Ω—Ç—É—Ä)"""
    
    def __init__(self):
        self.token = os.getenv('INVEST_TOKEN')
        if not self.token:
            log.error("‚ùå –¢–æ–∫–µ–Ω Tinkoff Invest API –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env —Ñ–∞–π–ª–µ")
            raise ValueError("–¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω")
        
        log.info("Tinkoff API –∫–ª–∏–µ–Ω—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω (–ë–û–ï–í–û–ô –ö–û–ù–¢–£–†)")
    
    def find_instrument_by_ticker(self, ticker):
        """–ù–∞—Ö–æ–¥–∏—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø–æ —Ç–∏–∫–µ—Ä—É –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –µ–≥–æ FIGI"""
        with Client(self.token) as client:
            instruments = client.instruments.find_instrument(query=ticker)
            for instrument in instruments.instruments:
                # –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –∏—Å–ø–æ–ª—å–∑—É–µ–º instrument.state –≤–º–µ—Å—Ç–æ instrument.instrument_status
                if instrument.ticker == ticker and instrument.state == InstrumentStatus.INSTRUMENT_STATUS_BASE:
                    log.info(f"–ù–∞–π–¥–µ–Ω –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: {instrument.name} ({instrument.ticker}), FIGI: {instrument.figi}")
                    return instrument
            log.error(f"–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å —Ç–∏–∫–µ—Ä–æ–º {ticker} –Ω–µ –Ω–∞–π–¥–µ–Ω")
            return None
    
    def get_orderbook(self, ticker: str, depth: int = 5):
        """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞–∫–∞–Ω –∑–∞—è–≤–æ–∫ –ø–æ —Ç–∏–∫–µ—Ä—É"""
        instrument = self.find_instrument_by_ticker(ticker)
        if not instrument:
            return None
            
        try:
            with Client(self.token) as client:
                request = GetOrderBookRequest(figi=instrument.figi, depth=depth)
                orderbook = client.market_data.get_order_book(request)
                
                return {
                    'ticker': ticker,
                    'instrument': instrument,
                    'orderbook': orderbook,
                    'timestamp': datetime.now()
                }
                
        except Exception as e:
            log.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞–∫–∞–Ω–∞ {ticker}: {e}")
            return None
    
    def print_pretty_orderbook(self, ticker: str, depth: int = 5):
        """–ö—Ä–∞—Å–∏–≤–æ –≤—ã–≤–æ–¥–∏–º —Å—Ç–∞–∫–∞–Ω"""
        data = self.get_orderbook(ticker, depth)
        
        if not data:
            print(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞–∫–∞–Ω –¥–ª—è {ticker}")
            return
        
        orderbook = data['orderbook']
        instrument = data['instrument']
        
        print(f"\nüìä –°—Ç–∞–∫–∞–Ω –ø–æ {ticker} ({instrument.name}):")
        print("=" * 60)
        
        # –í—ã–≤–æ–¥–∏–º –ø—Ä–æ–¥–∞–∂–∏ (asks) - —Å–≤–µ—Ä—Ö—É
        if orderbook.asks:
            print("üí∞ –ü–†–û–î–ê–ñ–ò (asks):")
            for ask in orderbook.asks:
                price = self.quotation_to_float(ask.price)
                quantity = ask.quantity
                print(f"   {price:10.2f} | {quantity:6} –ª–æ—Ç–æ–≤")
        
        print("-" * 30)
        
        # –í—ã–≤–æ–¥–∏–º –ø–æ–∫—É–ø–∫–∏ (bids) - —Å–Ω–∏–∑—É  
        if orderbook.bids:
            print("üõí –ü–û–ö–£–ü–ö–ò (bids):")
            for bid in orderbook.bids:
                price = self.quotation_to_float(bid.price)
                quantity = bid.quantity
                print(f"   {price:10.2f} | {quantity:6} –ª–æ—Ç–æ–≤")
        
        print("=" * 60)
        if hasattr(orderbook, 'best_bid') and orderbook.best_bid:
            print(f"üíé –õ—É—á—à–∏–π —Å–ø—Ä–æ—Å: {self.quotation_to_float(orderbook.best_bid):.2f}")
        if hasattr(orderbook, 'best_ask') and orderbook.best_ask:
            print(f"üíé –õ—É—á—à–µ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ: {self.quotation_to_float(orderbook.best_ask):.2f}")
        print(f"‚è∞ –í—Ä–µ–º—è: {data['timestamp'].strftime('%H:%M:%S')}")
    
    def quotation_to_float(self, quotation):
        """–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º Quotation –≤ float"""
        if hasattr(quotation, 'units') and hasattr(quotation, 'nano'):
            return quotation.units + quotation.nano / 1e9
        return float(quotation) if quotation else 0.0

if __name__ == "__main__":
    client = TinkoffAPIClient()
    client.print_pretty_orderbook("SBER")


================================================================================
–§–ê–ô–õ: src/data_feed/tinkoff_client_simple.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/src/data_feed/tinkoff_client_simple.py
================================================================================

import os
import sys
from datetime import datetime
from dotenv import load_dotenv

load_dotenv()

current_dir = os.path.dirname(os.path.abspath(__file__))
src_root = os.path.dirname(current_dir)
sys.path.insert(0, src_root)

from tinkoff.invest import Client
from utils.logger import log

class TinkoffAPIClientSimple:
    def __init__(self):
        self.token = os.getenv('INVEST_TOKEN')
        if not self.token:
            log.error("‚ùå –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env —Ñ–∞–π–ª–µ")
            raise ValueError("–¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω")
        log.info("Tinkoff API –∫–ª–∏–µ–Ω—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω (–ë–û–ï–í–û–ô –ö–û–ù–¢–£–†)")
    
    def find_instrument_by_ticker(self, ticker):
        with Client(self.token) as client:
            instruments = client.instruments.find_instrument(query=ticker)
            for instrument in instruments.instruments:
                if instrument.ticker == ticker:
                    log.info(f"–ù–∞–π–¥–µ–Ω –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: {instrument.name} ({instrument.ticker}), FIGI: {instrument.figi}")
                    # –£–ë–ò–†–ê–ï–ú –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ –∞—Ç—Ä–∏–±—É—Ç—ã
                    return instrument
            log.error(f"–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å —Ç–∏–∫–µ—Ä–æ–º {ticker} –Ω–µ –Ω–∞–π–¥–µ–Ω")
            return None
    
    def get_orderbook(self, ticker: str, depth: int = 5):
        instrument = self.find_instrument_by_ticker(ticker)
        if not instrument:
            return None
            
        try:
            with Client(self.token) as client:
                log.info(f"–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å—Ç–∞–∫–∞–Ω –¥–ª—è FIGI: {instrument.figi}, –≥–ª—É–±–∏–Ω–∞: {depth}")
                orderbook = client.market_data.get_order_book(figi=instrument.figi, depth=depth)
                
                # –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å—Ç–∞–∫–∞–Ω–∞
                log.info(f"–°—Ç–∞–∫–∞–Ω –ø–æ–ª—É—á–µ–Ω: {orderbook}")
                log.info(f"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ bids: {len(orderbook.bids)}")
                log.info(f"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ asks: {len(orderbook.asks)}")
                
                return {
                    'ticker': ticker,
                    'instrument': instrument,
                    'orderbook': orderbook,
                    'timestamp': datetime.now()
                }
                
        except Exception as e:
            log.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞–∫–∞–Ω–∞ {ticker}: {e}")
            return None
    
    def print_pretty_orderbook(self, ticker: str, depth: int = 5):
        data = self.get_orderbook(ticker, depth)
        
        if not data:
            print(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞–∫–∞–Ω –¥–ª—è {ticker}")
            return
        
        orderbook = data['orderbook']
        instrument = data['instrument']
        
        print(f"\nüìä –°—Ç–∞–∫–∞–Ω –ø–æ {ticker} ({instrument.name}):")
        print("=" * 60)
        
        if orderbook.asks:
            print("üí∞ –ü–†–û–î–ê–ñ–ò (asks):")
            for ask in orderbook.asks:
                price = self.quotation_to_float(ask.price)
                quantity = ask.quantity
                print(f"   {price:10.2f} | {quantity:6} –ª–æ—Ç–æ–≤")
        else:
            print("üí∞ –ü–†–û–î–ê–ñ–ò (asks): –ø—É—Å—Ç–æ")
        
        print("-" * 30)
        
        if orderbook.bids:
            print("üõí –ü–û–ö–£–ü–ö–ò (bids):")
            for bid in orderbook.bids:
                price = self.quotation_to_float(bid.price)
                quantity = bid.quantity
                print(f"   {price:10.2f} | {quantity:6} –ª–æ—Ç–æ–≤")
        else:
            print("üõí –ü–û–ö–£–ü–ö–ò (bids): –ø—É—Å—Ç–æ")
        
        print("=" * 60)
        if hasattr(orderbook, 'best_bid_price') and orderbook.best_bid_price:
            print(f"üíé –õ—É—á—à–∏–π —Å–ø—Ä–æ—Å: {self.quotation_to_float(orderbook.best_bid_price):.2f}")
        else:
            print(f"üíé –õ—É—á—à–∏–π —Å–ø—Ä–æ—Å: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö")
            
        if hasattr(orderbook, 'best_ask_price') and orderbook.best_ask_price:
            print(f"üíé –õ—É—á—à–µ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ: {self.quotation_to_float(orderbook.best_ask_price):.2f}")
        else:
            print(f"üíé –õ—É—á—à–µ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö")
            
        print(f"‚è∞ –í—Ä–µ–º—è: {data['timestamp'].strftime('%H:%M:%S')}")
    
    def quotation_to_float(self, quotation):
        if hasattr(quotation, 'units') and hasattr(quotation, 'nano'):
            return quotation.units + quotation.nano / 1e9
        return float(quotation) if quotation else 0.0

if __name__ == "__main__":
    client = TinkoffAPIClientSimple()
    client.print_pretty_orderbook("SBER")


================================================================================
–§–ê–ô–õ: src/execution/__init__.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/src/execution/__init__.py
================================================================================



================================================================================
–§–ê–ô–õ: src/risk_management/__init__.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/src/risk_management/__init__.py
================================================================================



================================================================================
–§–ê–ô–õ: src/strategies/__init__.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/src/strategies/__init__.py
================================================================================



================================================================================
–§–ê–ô–õ: src/utils/__init__.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/src/utils/__init__.py
================================================================================



================================================================================
–§–ê–ô–õ: src/utils/logger.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/src/utils/logger.py
================================================================================

from loguru import logger
import sys
import os

def setup_logger():
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–≥–µ—Ä–∞ –¥–ª—è trading –±–æ—Ç–∞"""
    
    # –°–æ–∑–¥–∞—ë–º –ø–∞–ø–∫—É –¥–ª—è –ª–æ–≥–æ–≤ –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
    os.makedirs("logs", exist_ok=True)
    
    # –£–±–∏—Ä–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π handler
    logger.remove()
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Å–æ–ª—å–Ω—ã–π handler
    logger.add(
        sys.stdout,
        format="<green>{time:YYYY-MM-DD HH:mm:ss}</green> | <level>{level: <8}</level> | <cyan>{name}</cyan>:<cyan>{function}</cyan>:<cyan>{line}</cyan> - <level>{message}</level>",
        level="INFO",
        colorize=True
    )
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª–æ–≤—ã–π handler
    logger.add(
        "logs/trading_bot.log",
        rotation="10 MB",
        retention="10 days",
        level="DEBUG",
        format="{time:YYYY-MM-DD HH:mm:ss} | {level: <8} | {name}:{function}:{line} - {message}"
    )
    
    return logger

# –°–æ–∑–¥–∞—ë–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –ª–æ–≥–≥–µ—Ä
log = setup_logger()

if __name__ == "__main__":
    log.info("–õ–æ–≥–≥–µ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!")
    log.debug("–û—Ç–ª–∞–¥–æ—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ")
    log.warning("–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ")


================================================================================
–§–ê–ô–õ: telegram_bot/__init__.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/telegram_bot/__init__.py
================================================================================



================================================================================
–§–ê–ô–õ: telegram_bot/bot.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/telegram_bot/bot.py
================================================================================

#!/usr/bin/env python3
"""
–û—Å–Ω–æ–≤–Ω–æ–π –º–æ–¥—É–ª—å Telegram –±–æ—Ç–∞
–ó–∞–ø—É—Å–∫: python telegram_bot/bot.py
"""

import os
import sys
import asyncio
from pathlib import Path

# –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ –≤ –ø—É—Ç—å Python
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

from dotenv import load_dotenv
from telegram import Update
from telegram.ext import Application, CommandHandler, ContextTypes

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
from telegram_bot.handlers.basic import start, help_command, status
from telegram_bot.handlers.settings import set_ticker, set_depth, set_interval
from telegram_bot.handlers.orderbook import get_orderbook, start_monitoring, stop_monitoring

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()

# –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
TELEGRAM_BOT_TOKEN = os.getenv('TELEGRAM_BOT_TOKEN')

def create_application():
    """–°–æ–∑–¥–∞—ë—Ç –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±–æ—Ç–∞"""
    # –°–æ–∑–¥–∞—ë–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    application = Application.builder().token(TELEGRAM_BOT_TOKEN).build()
    
    # –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("help", help_command))
    application.add_handler(CommandHandler("status", status))
    
    application.add_handler(CommandHandler("ticker", set_ticker))
    application.add_handler(CommandHandler("depth", set_depth))
    application.add_handler(CommandHandler("interval", set_interval))
    
    application.add_handler(CommandHandler("orderbook", get_orderbook))
    application.add_handler(CommandHandler("start_monitoring", start_monitoring))
    application.add_handler(CommandHandler("stop_monitoring", stop_monitoring))
    
    return application

async def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞"""
    print("ü§ñ –ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...")
    
    if not TELEGRAM_BOT_TOKEN or "–≤–∞—à_—Ç–æ–∫–µ–Ω" in TELEGRAM_BOT_TOKEN:
        print("‚ùå –¢–æ–∫–µ–Ω –±–æ—Ç–∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!")
        print("   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ TELEGRAM_BOT_TOKEN –≤ .env —Ñ–∞–π–ª–µ")
        return
    
    try:
        # –°–æ–∑–¥–∞—ë–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        application = create_application()
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
        print("‚úÖ –ë–æ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
        print("üì° –ó–∞–ø—É—Å–∫–∞–µ–º polling... (Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏)")
        
        await application.initialize()
        await application.start()
        await application.updater.start_polling()
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª
        await application.idle()
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞: {e}")

if __name__ == "__main__":
    # –ó–∞–ø—É—Å–∫–∞–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
    asyncio.run(main())


================================================================================
–§–ê–ô–õ: telegram_bot/config.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/telegram_bot/config.py
================================================================================

#!/usr/bin/env python3
"""
–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±–æ—Ç–∞
"""

import os
from dotenv import load_dotenv

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞ –∏–∑ .env
TELEGRAM_BOT_TOKEN = os.getenv('TELEGRAM_BOT_TOKEN', '–≤–∞—à_—Ç–æ–∫–µ–Ω_–±–æ—Ç–∞_—Å—é–¥–∞')
TELEGRAM_CHAT_ID = os.getenv('TELEGRAM_CHAT_ID', '–≤–∞—à_chat_id_—Å—é–¥–∞')

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Tinkoff –∏–∑ .env
INVEST_TOKEN = os.getenv('INVEST_TOKEN', '–≤–∞—à_—Ç–æ–∫–µ–Ω_—Å—é–¥–∞')
SANDBOX = os.getenv('SANDBOX', 'true').lower() == 'true'

# –°–æ—Å—Ç–æ—è–Ω–∏–µ –±–æ—Ç–∞ (—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏)
bot_state = {
    'ticker': os.getenv('DEFAULT_TICKER', 'SBER'),
    'depth': int(os.getenv('DEFAULT_DEPTH', 5)),
    'interval': int(os.getenv('DEFAULT_INTERVAL', 10)),
    'monitoring_job': None  # –ó–∞–¥–∞—á–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
}


================================================================================
–§–ê–ô–õ: telegram_bot/get_chat_id.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/telegram_bot/get_chat_id.py
================================================================================

#!/usr/bin/env python3
"""
–ü–æ–ª—É—á–µ–Ω–∏–µ Chat ID –¥–ª—è Telegram –±–æ—Ç–∞
–ó–∞–ø—É—Å–∫: python telegram_bot/get_chat_id.py
"""

import os
import sys
import asyncio
from pathlib import Path

# –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ –≤ –ø—É—Ç—å Python
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

from dotenv import load_dotenv
from telegram import Bot
from telegram.error import TelegramError

async def get_chat_id():
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env
    load_dotenv()
    
    token = os.getenv('TELEGRAM_BOT_TOKEN')
    
    if not token:
        print("‚ùå –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env —Ñ–∞–π–ª–µ")
        print("   –î–æ–±–∞–≤—å—Ç–µ TELEGRAM_BOT_TOKEN=–≤–∞—à_—Ç–æ–∫–µ–Ω –≤ .env")
        return False
    
    if "–≤–∞—à_—Ç–æ–∫–µ–Ω_–±–æ—Ç–∞_—Å—é–¥–∞" in token or "your_bot_token_here" in token:
        print("‚ùå –¢–æ–∫–µ–Ω –Ω–µ –∏–∑–º–µ–Ω–µ–Ω!")
        print("   –ó–∞–º–µ–Ω–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ TELEGRAM_BOT_TOKEN –≤ .env –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω")
        return False
    
    print("üîç –ü–û–õ–£–ß–ï–ù–ò–ï TELEGRAM CHAT ID")
    
    try:
        bot = Bot(token=token)
        print("üîÑ –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–æ—Ç—É...")
        bot_info = await bot.get_me()
        print(f"‚úÖ –ë–æ—Ç: @{bot_info.username}")
        
        print("üì© –ò—â–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è...")
        updates = await bot.get_updates(timeout=10, limit=10)
        
        if not updates:
            print("‚ùå –°–æ–æ–±—â–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ!")
            print("üì± –ß—Ç–æ –¥–µ–ª–∞—Ç—å:")
            print("   1. –û—Ç–∫—Ä–æ–π—Ç–µ –¢–µ–ª–µ–≥—Ä–∞–º")
            print(f"   2. –ù–∞–π–¥–∏—Ç–µ –±–æ—Ç–∞: @{bot_info.username}")
            print("   3. –ù–∞–∂–º–∏—Ç–µ START –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ –ª—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ")
            print("   4. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç —Å–Ω–æ–≤–∞")
            return False
        
        print(f"‚úÖ –ù–∞–π–¥–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π: {len(updates)}")
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Ç
        last_update = updates[-1]
        if last_update.message:
            chat_id = last_update.message.chat.id
        elif last_update.callback_query:
            chat_id = last_update.callback_query.message.chat.id
        else:
            print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å chat_id")
            return False
        
        print(f"üéØ –ü–û–°–õ–ï–î–ù–ò–ô –ß–ê–¢ ID: {chat_id}")
        
        # –û–±–Ω–æ–≤–ª—è–µ–º .env —Ñ–∞–π–ª
        env_path = project_root / ".env"
        if env_path.exists():
            with open(env_path, "r") as f:
                lines = f.readlines()
            
            updated = False
            for i, line in enumerate(lines):
                if line.strip().startswith("TELEGRAM_CHAT_ID="):
                    lines[i] = f"TELEGRAM_CHAT_ID={chat_id}\n"
                    updated = True
                    break
            
            if not updated:
                lines.append(f"\nTELEGRAM_CHAT_ID={chat_id}\n")
            
            with open(env_path, "w") as f:
                f.writelines(lines)
            
            print(f"‚úÖ Chat ID —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ .env —Ñ–∞–π–ª")
        else:
            print(f"üìù –°–æ–∑–¥–∞–π—Ç–µ .env –∏ –¥–æ–±–∞–≤—å—Ç–µ —Å—Ç—Ä–æ–∫—É:")
            print(f"TELEGRAM_CHAT_ID={chat_id}")
        
        return True
        
    except TelegramError as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ Telegram API: {e}")
        return False
    except Exception as e:
        print(f"‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}")
        return False

def main():
    print("üöÄ –ó–∞–ø—É—Å–∫ –ø–æ–ª—É—á–µ–Ω–∏—è Chat ID –¥–ª—è Telegram –±–æ—Ç–∞")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
    if sys.prefix == sys.base_prefix:
        print("‚ö†Ô∏è  –°–æ–≤–µ—Ç: –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ: source trading_env/bin/activate")
    
    success = asyncio.run(get_chat_id())
    
    if success:
        print("üéâ –ì–æ—Ç–æ–≤–æ! Chat ID –ø–æ–ª—É—á–µ–Ω –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω.")
    else:
        print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å Chat ID")
    
    return 0 if success else 1

if __name__ == "__main__":
    sys.exit(main())


================================================================================
–§–ê–ô–õ: telegram_bot/handlers/__init__.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/telegram_bot/handlers/__init__.py
================================================================================



================================================================================
–§–ê–ô–õ: telegram_bot/handlers/basic.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/telegram_bot/handlers/basic.py
================================================================================

#!/usr/bin/env python3
"""
–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –±–∞–∑–æ–≤—ã—Ö –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞
"""

from telegram import Update
from telegram.ext import ContextTypes
from telegram_bot.config import bot_state

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    welcome_text = """
ü§ñ <b>–¢–æ—Ä–≥–æ–≤—ã–π –±–æ—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞–∫–∞–Ω–∞</b>

–Ø –ø–æ–º–æ–≥–∞—é –ø–æ–ª—É—á–∞—Ç—å —Å—Ç–∞–∫–∞–Ω –∑–∞—è–≤–æ–∫ —Å –±–∏—Ä–∂–∏ —á–µ—Ä–µ–∑ Telegram.

<b>–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>
/ticker <—Ç–∏–∫–µ—Ä> - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–∏–∫–µ—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä: /ticker SBER)
/depth <—á–∏—Å–ª–æ> - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≥–ª—É–±–∏–Ω—É —Å—Ç–∞–∫–∞–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: /depth 10)
/interval <—Å–µ–∫—É–Ω–¥—ã> - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª –æ—Ç–ø—Ä–∞–≤–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: /interval 5)

<b>–ö–æ–º–∞–Ω–¥—ã —Å—Ç–∞–∫–∞–Ω–∞:</b>
/orderbook - –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Å—Ç–∞–∫–∞–Ω
/start_monitoring - –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫—É—é –æ—Ç–ø—Ä–∞–≤–∫—É
/stop_monitoring - –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É

<b>–î—Ä—É–≥–∏–µ –∫–æ–º–∞–Ω–¥—ã:</b>
/status - —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
/help - –ø–æ–º–æ—â—å

<b>–ü—Ä–∏–º–µ—Ä –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:</b>
/ticker SBER
/depth 5
/interval 10
/start_monitoring
"""
    await update.message.reply_text(welcome_text, parse_mode='HTML')

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help"""
    help_text = """
üìö <b>–°–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º</b>

<b>–ù–∞—Å—Ç—Ä–æ–π–∫–∏:</b>
‚Ä¢ /ticker <—Ç–∏–∫–µ—Ä> - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–∏–∫–µ—Ä –±—É–º–∞–≥–∏ (–ø—Ä–∏–º–µ—Ä: SBER, GAZP, YNDX)
‚Ä¢ /depth <—á–∏—Å–ª–æ> - –ì–ª—É–±–∏–Ω–∞ —Å—Ç–∞–∫–∞–Ω–∞ (–æ—Ç 1 –¥–æ 50)
‚Ä¢ /interval <—Å–µ–∫—É–Ω–¥—ã> - –ò–Ω—Ç–µ—Ä–≤–∞–ª –æ—Ç–ø—Ä–∞–≤–∫–∏ (–æ—Ç 1 –¥–æ 3600)

<b>–°—Ç–∞–∫–∞–Ω:</b>
‚Ä¢ /orderbook - –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Å—Ç–∞–∫–∞–Ω
‚Ä¢ /start_monitoring - –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫—É—é –æ—Ç–ø—Ä–∞–≤–∫—É
‚Ä¢ /stop_monitoring - –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É

<b>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</b>
‚Ä¢ /status - –¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
‚Ä¢ /help - –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞

<b>–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:</b>
1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞: /ticker SBER ‚Üí /depth 10 ‚Üí /interval 30
2. –¢–µ—Å—Ç: /orderbook
3. –ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞: /start_monitoring
4. –û—Å—Ç–∞–Ω–æ–≤–∫–∞: /stop_monitoring
"""
    await update.message.reply_text(help_text, parse_mode='HTML')

async def status(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /status"""
    ticker = bot_state.get('ticker', 'SBER')
    depth = bot_state.get('depth', 5)
    interval = bot_state.get('interval', 10)
    monitoring = "‚úÖ –ó–∞–ø—É—â–µ–Ω" if bot_state.get('monitoring_job') else "‚ùå –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    
    status_text = f"""
üìä <b>–¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:</b>

üìà <b>–¢–∏–∫–µ—Ä:</b> {ticker}
üìè <b>–ì–ª—É–±–∏–Ω–∞ —Å—Ç–∞–∫–∞–Ω–∞:</b> {depth}
‚è∞ <b>–ò–Ω—Ç–µ—Ä–≤–∞–ª –æ—Ç–ø—Ä–∞–≤–∫–∏:</b> {interval} —Å–µ–∫—É–Ω–¥
üîÑ <b>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:</b> {monitoring}

<b>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ:</b>
/orderbook - –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞–∫–∞–Ω —Å–µ–π—á–∞—Å
/start_monitoring - –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫—É—é –æ—Ç–ø—Ä–∞–≤–∫—É
/help - —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–æ–º–∞–Ω–¥
"""
    await update.message.reply_text(status_text, parse_mode='HTML')


================================================================================
–§–ê–ô–õ: telegram_bot/handlers/orderbook.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/telegram_bot/handlers/orderbook.py
================================================================================

#!/usr/bin/env python3
"""
–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–æ —Å—Ç–∞–∫–∞–Ω–æ–º
"""

import asyncio
from telegram import Update
from telegram.ext import ContextTypes
from telegram_bot.config import bot_state
from telegram_bot.services.orderbook_service import get_orderbook as get_orderbook_data, format_orderbook_message

async def get_orderbook(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /orderbook"""
    try:
        # –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        ticker = bot_state.get('ticker', 'SBER')
        depth = bot_state.get('depth', 5)
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è
        await update.message.reply_text(f"üîç –ü–æ–ª—É—á–∞—é —Å—Ç–∞–∫–∞–Ω {ticker}...")
        
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å—Ç–∞–∫–∞–Ω–∞
        orderbook_data = await get_orderbook_data(ticker, depth)
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
        message = await format_orderbook_message(orderbook_data)
        await update.message.reply_text(message, parse_mode='HTML')
        
    except Exception as e:
        await update.message.reply_text(f"‚ùå –û—à–∏–±–∫–∞: {str(e)[:100]}")

async def send_orderbook_job(context: ContextTypes.DEFAULT_TYPE):
    """–ó–∞–¥–∞—á–∞ –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å—Ç–∞–∫–∞–Ω–∞"""
    try:
        # –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        ticker = bot_state.get('ticker', 'SBER')
        depth = bot_state.get('depth', 5)
        
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å—Ç–∞–∫–∞–Ω–∞
        orderbook_data = await get_orderbook_data(ticker, depth)
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        message = await format_orderbook_message(orderbook_data)
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        await context.bot.send_message(
            chat_id=context.job.chat_id,
            text=message,
            parse_mode='HTML'
        )
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –≤ –∑–∞–¥–∞—á–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞: {e}")

async def start_monitoring(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start_monitoring"""
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–ø—É—â–µ–Ω –ª–∏ —É–∂–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
        if bot_state.get('monitoring_job'):
            await update.message.reply_text("‚ö†Ô∏è –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —É–∂–µ –∑–∞–ø—É—â–µ–Ω!")
            return
        
        # –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        ticker = bot_state.get('ticker', 'SBER')
        depth = bot_state.get('depth', 5)
        interval = bot_state.get('interval', 10)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª
        if interval < 1:
            await update.message.reply_text("‚ùå –ò–Ω—Ç–µ—Ä–≤–∞–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 1 —Å–µ–∫—É–Ω–¥—ã")
            return
        
        # –°–æ–∑–¥–∞–µ–º –∑–∞–¥–∞—á—É –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
        job_queue = context.job_queue
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–¥–∞—á—É
        job = job_queue.run_repeating(
            send_orderbook_job,
            interval=interval,
            first=1,
            chat_id=update.effective_chat.id,
            name=f"orderbook_monitoring_{ticker}"
        )
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–¥–∞—á—É –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
        bot_state['monitoring_job'] = job
        
        await update.message.reply_text(
            f"‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–ø—É—â–µ–Ω!\n\n"
            f"üìä <b>–¢–∏–∫–µ—Ä:</b> {ticker}\n"
            f"üìè <b>–ì–ª—É–±–∏–Ω–∞:</b> {depth}\n"
            f"‚è∞ <b>–ò–Ω—Ç–µ—Ä–≤–∞–ª:</b> {interval} —Å–µ–∫\n\n"
            f"–î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏: /stop_monitoring",
            parse_mode='HTML'
        )
        
    except Exception as e:
        await update.message.reply_text(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞: {str(e)[:100]}")

async def stop_monitoring(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /stop_monitoring"""
    try:
        job = bot_state.get('monitoring_job')
        if job:
            job.schedule_removal()
            bot_state['monitoring_job'] = None
            await update.message.reply_text("‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")
        else:
            await update.message.reply_text("‚ö†Ô∏è –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–µ –±—ã–ª –∑–∞–ø—É—â–µ–Ω")
    except Exception as e:
        await update.message.reply_text(f"‚ùå –û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞: {str(e)[:100]}")


================================================================================
–§–ê–ô–õ: telegram_bot/handlers/settings.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/telegram_bot/handlers/settings.py
================================================================================

#!/usr/bin/env python3
"""
–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
"""

from telegram import Update
from telegram.ext import ContextTypes
from telegram_bot.config import bot_state

async def set_ticker(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /ticker"""
    if not context.args:
        await update.message.reply_text("‚ùå –£–∫–∞–∂–∏—Ç–µ —Ç–∏–∫–µ—Ä. –ü—Ä–∏–º–µ—Ä: /ticker SBER")
        return
    
    ticker = context.args[0].upper().strip()
    
    # –ü—Ä–æ—Å—Ç–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ç–∏–∫–µ—Ä–∞
    if not ticker.isalpha():
        await update.message.reply_text("‚ùå –¢–∏–∫–µ—Ä –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã")
        return
    
    if len(ticker) > 10:
        await update.message.reply_text("‚ùå –¢–∏–∫–µ—Ä —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π")
        return
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
    bot_state['ticker'] = ticker
    
    await update.message.reply_text(f"‚úÖ –¢–∏–∫–µ—Ä —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: <b>{ticker}</b>\n\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /orderbook –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏", parse_mode='HTML')

async def set_depth(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /depth"""
    if not context.args:
        await update.message.reply_text("‚ùå –£–∫–∞–∂–∏—Ç–µ –≥–ª—É–±–∏–Ω—É. –ü—Ä–∏–º–µ—Ä: /depth 10")
        return
    
    try:
        depth = int(context.args[0])
        
        if depth < 1 or depth > 50:
            await update.message.reply_text("‚ùå –ì–ª—É–±–∏–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 1 –¥–æ 50")
            return
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
        bot_state['depth'] = depth
        
        await update.message.reply_text(f"‚úÖ –ì–ª—É–±–∏–Ω–∞ —Å—Ç–∞–∫–∞–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: <b>{depth}</b>", parse_mode='HTML')
        
    except ValueError:
        await update.message.reply_text("‚ùå –ì–ª—É–±–∏–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–∏—Å–ª–æ–º")

async def set_interval(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /interval"""
    if not context.args:
        await update.message.reply_text("‚ùå –£–∫–∞–∂–∏—Ç–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª. –ü—Ä–∏–º–µ—Ä: /interval 10")
        return
    
    try:
        interval = int(context.args[0])
        
        if interval < 1:
            await update.message.reply_text("‚ùå –ò–Ω—Ç–µ—Ä–≤–∞–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 1 —Å–µ–∫—É–Ω–¥—ã")
            return
        
        if interval > 3600:
            await update.message.reply_text("‚ùå –ò–Ω—Ç–µ—Ä–≤–∞–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –±–æ–ª–µ–µ 3600 —Å–µ–∫—É–Ω–¥ (1 —á–∞—Å)")
            return
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
        bot_state['interval'] = interval
        
        # –ï—Å–ª–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–ø—É—â–µ–Ω, –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –µ–≥–æ —Å –Ω–æ–≤—ã–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º
        job = bot_state.get('monitoring_job')
        if job:
            job.schedule_removal()
            bot_state['monitoring_job'] = None
            await update.message.reply_text(
                f"‚úÖ –ò–Ω—Ç–µ—Ä–≤–∞–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: <b>{interval}</b> —Å–µ–∫—É–Ω–¥\n\n"
                f"‚ö†Ô∏è –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –±—ã–ª –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–Ω–æ–≤–∞: /start_monitoring",
                parse_mode='HTML'
            )
        else:
            await update.message.reply_text(f"‚úÖ –ò–Ω—Ç–µ—Ä–≤–∞–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: <b>{interval}</b> —Å–µ–∫—É–Ω–¥", parse_mode='HTML')
        
    except ValueError:
        await update.message.reply_text("‚ùå –ò–Ω—Ç–µ—Ä–≤–∞–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º")


================================================================================
–§–ê–ô–õ: telegram_bot/services/__init__.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/telegram_bot/services/__init__.py
================================================================================



================================================================================
–§–ê–ô–õ: telegram_bot/services/orderbook_service.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/telegram_bot/services/orderbook_service.py
================================================================================

#!/usr/bin/env python3
"""
–°–µ—Ä–≤–∏—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞–∫–∞–Ω–∞ —á–µ—Ä–µ–∑ Tinkoff API
"""

import asyncio
from typing import Optional, Dict, Any
from telegram_bot.services.tinkoff_service import get_tinkoff_service

async def get_orderbook(ticker: str, depth: int = 5) -> Optional[Dict[str, Any]]:
    """
    –ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞–∫–∞–Ω –ø–æ —Ç–∏–∫–µ—Ä—É —á–µ—Ä–µ–∑ Tinkoff API
    
    Args:
        ticker: –¢–∏–∫–µ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'SBER')
        depth: –ì–ª—É–±–∏–Ω–∞ —Å—Ç–∞–∫–∞–Ω–∞
        
    Returns:
        –°–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ —Å—Ç–∞–∫–∞–Ω–∞ –∏–ª–∏ None –ø—Ä–∏ –æ—à–∏–±–∫–µ
    """
    try:
        # –ü–æ–ª—É—á–∞–µ–º —Å–µ—Ä–≤–∏—Å
        service = await get_tinkoff_service()
        
        # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞–∫–∞–Ω
        orderbook_data = await service.get_orderbook(ticker, depth)
        
        return orderbook_data
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –≤ get_orderbook: {e}")
        return None

async def format_orderbook_message(data: Dict[str, Any]) -> str:
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ —Å—Ç–∞–∫–∞–Ω–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram
    
    Args:
        data: –î–∞–Ω–Ω—ã–µ —Å—Ç–∞–∫–∞–Ω–∞
        
    Returns:
        –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    """
    if not data:
        return "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å—Ç–∞–∫–∞–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–∏–∫–µ—Ä –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É."
    
    try:
        service = await get_tinkoff_service()
        return service.format_orderbook_for_telegram(data)
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: {e}")
        return "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö —Å—Ç–∞–∫–∞–Ω–∞."


================================================================================
–§–ê–ô–õ: telegram_bot/services/tinkoff_service.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/telegram_bot/services/tinkoff_service.py
================================================================================

#!/usr/bin/env python3
"""
–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Tinkoff API (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π)
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç gRPC –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞–∫–∞–Ω–æ–≤
"""

import os
import asyncio
from datetime import datetime
from typing import Optional, Dict, Any
from pathlib import Path
import sys

# –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ –≤ –ø—É—Ç—å Python
project_root = Path(__file__).parent.parent.parent
sys.path.insert(0, str(project_root))

from dotenv import load_dotenv

load_dotenv()

try:
    from tinkoff.invest import AsyncClient
    from tinkoff.invest.schemas import InstrumentStatus, InstrumentIdType
    print("‚úÖ Tinkoff –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã")
except ImportError as e:
    print(f"‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ Tinkoff: {e}")
    raise

class TinkoffService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Tinkoff Invest API"""
    
    def __init__(self):
        self.token = os.getenv('INVEST_TOKEN')
        if not self.token:
            raise ValueError("‚ùå –¢–æ–∫–µ–Ω Tinkoff API –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env —Ñ–∞–π–ª–µ")
        
        self._client = None
        print("üöÄ TinkoffService –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
    
    async def __aenter__(self):
        """–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä"""
        self._client = AsyncClient(self.token)
        await self._client.__aenter__()
        return self
    
    async def __aexit__(self, exc_type, exc_val, exc_tb):
        """–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã"""
        if self._client:
            await self._client.__aexit__(exc_type, exc_val, exc_tb)
    
    async def find_instrument_by_ticker(self, ticker: str):
        """–ù–∞—Ö–æ–¥–∏—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø–æ —Ç–∏–∫–µ—Ä—É"""
        try:
            # –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º –≤—Å–µ –∞–∫—Ü–∏–∏
            shares_response = await self._client.instruments.shares()
            
            # –ò—â–µ–º –ø–æ —Ç–æ—á–Ω–æ–º—É —Ç–∏–∫–µ—Ä—É
            for instrument in shares_response.instruments:
                if (instrument.ticker == ticker and 
                    instrument.exchange == 'MOEX' and
                    instrument.class_code == 'TQBR'):
                    print(f"‚úÖ –ù–∞–π–¥–µ–Ω–∞ –∞–∫—Ü–∏—è: {instrument.name} ({instrument.ticker})")
                    return instrument
            
            print(f"‚ùå –ê–∫—Ü–∏—è —Å —Ç–∏–∫–µ—Ä–æ–º '{ticker}' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –Ω–∞ MOEX")
            return None
            
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ '{ticker}': {e}")
            return None
    
    async def get_orderbook(self, ticker: str, depth: int = 5) -> Optional[Dict[str, Any]]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞–∫–∞–Ω –ø–æ —Ç–∏–∫–µ—Ä—É
        
        Returns:
            –°–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ —Å—Ç–∞–∫–∞–Ω–∞ –∏–ª–∏ None –ø—Ä–∏ –æ—à–∏–±–∫–µ
        """
        try:
            instrument = await self.find_instrument_by_ticker(ticker)
            if not instrument:
                return None
            
            # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞–∫–∞–Ω
            orderbook = await self._client.market_data.get_order_book(
                figi=instrument.figi,
                depth=depth
            )
            
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            result = {
                'ticker': ticker,
                'name': instrument.name,
                'asks': [],
                'bids': [],
                'best_bid': None,
                'best_ask': None,
                'timestamp': datetime.now()
            }
            
            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∞—Å–∫–∏ (–ø—Ä–æ–¥–∞–∂–∞)
            if orderbook.asks:
                result['best_ask'] = self._quotation_to_float(orderbook.best_ask_price)
                for ask in orderbook.asks[:depth]:
                    price = self._quotation_to_float(ask.price)
                    quantity = ask.quantity
                    result['asks'].append({
                        'price': price,
                        'quantity': quantity
                    })
            
            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –±–∏–¥—ã (–ø–æ–∫—É–ø–∫–∞)
            if orderbook.bids:
                result['best_bid'] = self._quotation_to_float(orderbook.best_bid_price)
                for bid in orderbook.bids[:depth]:
                    price = self._quotation_to_float(bid.price)
                    quantity = bid.quantity
                    result['bids'].append({
                        'price': price,
                        'quantity': quantity
                    })
            
            return result
            
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞–∫–∞–Ω–∞ '{ticker}': {e}")
            return None
    
    def _quotation_to_float(self, quotation) -> float:
        """–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç Quotation –≤ float"""
        if hasattr(quotation, 'units') and hasattr(quotation, 'nano'):
            return quotation.units + quotation.nano / 1e9
        return float(quotation) if quotation else 0.0
    
    def format_orderbook_for_telegram(self, data: Dict[str, Any]) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å—Ç–∞–∫–∞–Ω –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram"""
        if not data:
            return "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å—Ç–∞–∫–∞–Ω–∞"
        
        # –°–æ–∑–¥–∞—ë–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        timestamp = data['timestamp'].strftime('%H:%M:%S')
        message = f"üìä <b>–°–¢–ê–ö–ê–ù {data['ticker']}</b>\n"
        message += f"<i>{data['name']}</i>\n\n"
        
        # –ü—Ä–æ–¥–∞–∂–∞ (asks)
        if data['asks']:
            message += "üí∞ <b>–ü–†–û–î–ê–ñ–ê:</b>\n"
            for ask in data['asks'][:5]:  # –¢–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 5 —É—Ä–æ–≤–Ω–µ–π
                message += f"  {ask['price']:>8.2f} | {ask['quantity']:>6} –ª–æ—Ç–æ–≤\n"
        else:
            message += "üí∞ <b>–ü–†–û–î–ê–ñ–ê:</b> –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö\n"
        
        message += "\n"
        
        # –ü–æ–∫—É–ø–∫–∞ (bids)
        if data['bids']:
            message += "üõí <b>–ü–û–ö–£–ü–ö–ê:</b>\n"
            for bid in data['bids'][:5]:
                message += f"  {bid['price']:>8.2f} | {bid['quantity']:>6} –ª–æ—Ç–æ–≤\n"
        else:
            message += "üõí <b>–ü–û–ö–£–ü–ö–ê:</b> –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö\n"
        
        message += "\n"
        
        # –°–ø—Ä–µ–¥ –∏ –≤—Ä–µ–º—è
        if data['best_bid'] and data['best_ask']:
            spread = data['best_ask'] - data['best_bid']
            spread_percent = (spread / data['best_bid']) * 100
            message += f"üíé <b>–°–ø—Ä–æ—Å:</b> {data['best_bid']:.2f}\n"
            message += f"üíé <b>–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:</b> {data['best_ask']:.2f}\n"
            message += f"üìè <b>–°–ø—Ä–µ–¥:</b> {spread:.2f} ({spread_percent:.2f}%)\n"
        
        message += f"‚è∞ <i>{timestamp}</i>"
        
        return message

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–µ—Ä–≤–∏—Å–∞ (–¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞)
_tinkoff_service = None

async def get_tinkoff_service():
    """–ü–æ–ª—É—á–∞–µ—Ç –∏–ª–∏ —Å–æ–∑–¥–∞—ë—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä TinkoffService"""
    global _tinkoff_service
    if _tinkoff_service is None:
        _tinkoff_service = TinkoffService()
        await _tinkoff_service.__aenter__()
    return _tinkoff_service

async def close_tinkoff_service():
    """–ó–∞–∫—Ä—ã–≤–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å Tinkoff"""
    global _tinkoff_service
    if _tinkoff_service:
        await _tinkoff_service.__aexit__(None, None, None)
        _tinkoff_service = None
def format_orderbook_for_telegram(data: Dict[str, Any]) -> str:
    """–°—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç–∞–∫–∞–Ω–∞"""
    if not data:
        return "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å—Ç–∞–∫–∞–Ω–∞"
    
    # –°–æ–∑–¥–∞—ë–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
    timestamp = data['timestamp'].strftime('%H:%M:%S')
    message = f"üìä <b>–°–¢–ê–ö–ê–ù {data['ticker']}</b>\n"
    message += f"<i>{data['name']}</i>\n\n"
    
    # –ü—Ä–æ–¥–∞–∂–∞ (asks)
    if data['asks']:
        message += "üí∞ <b>–ü–†–û–î–ê–ñ–ê:</b>\n"
        for ask in data['asks'][:5]:  # –¢–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 5 —É—Ä–æ–≤–Ω–µ–π
            message += f"  {ask['price']:>8.2f} | {ask['quantity']:>6} –ª–æ—Ç–æ–≤\n"
    else:
        message += "üí∞ <b>–ü–†–û–î–ê–ñ–ê:</b> –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö\n"
    
    message += "\n"
    
    # –ü–æ–∫—É–ø–∫–∞ (bids)
    if data['bids']:
        message += "üõí <b>–ü–û–ö–£–ü–ö–ê:</b>\n"
        for bid in data['bids'][:5]:
            message += f"  {bid['price']:>8.2f} | {bid['quantity']:>6} –ª–æ—Ç–æ–≤\n"
    else:
        message += "üõí <b>–ü–û–ö–£–ü–ö–ê:</b> –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö\n"
    
    message += "\n"
    
    # –°–ø—Ä–µ–¥ –∏ –≤—Ä–µ–º—è
    if data['best_bid'] and data['best_ask']:
        spread = data['best_ask'] - data['best_bid']
        spread_percent = (spread / data['best_bid']) * 100
        message += f"üíé <b>–°–ø—Ä–æ—Å:</b> {data['best_bid']:.2f}\n"
        message += f"üíé <b>–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:</b> {data['best_ask']:.2f}\n"
        message += f"üìè <b>–°–ø—Ä–µ–¥:</b> {spread:.2f} ({spread_percent:.2f}%)\n"
    
    message += f"‚è∞ <i>{timestamp}</i>"
    
    return message


================================================================================
–§–ê–ô–õ: telegram_bot/utils/__init__.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/telegram_bot/utils/__init__.py
================================================================================



================================================================================
–§–ê–ô–õ: telegram_bot/utils/formatters.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/telegram_bot/utils/formatters.py
================================================================================

"""
–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è Telegram
"""

def format_settings_message(ticker: str, depth: int, interval: int, is_monitoring: bool) -> str:
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ç–µ–∫—É—â–∏–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
    """
    status = "üü¢ –í–ö–õ" if is_monitoring else "üî¥ –í–´–ö–õ"
    
    message = (
        f"‚öôÔ∏è –¢–ï–ö–£–©–ò–ï –ù–ê–°–¢–†–û–ô–ö–ò:\n\n"
        f"üìà –¢–∏–∫–µ—Ä: {ticker}\n"
        f"üìä –ì–ª—É–±–∏–Ω–∞ —Å—Ç–∞–∫–∞–Ω–∞: {depth}\n"
        f"‚è± –ò–Ω—Ç–µ—Ä–≤–∞–ª –æ—Ç–ø—Ä–∞–≤–∫–∏: {interval} —Å–µ–∫.\n"
        f"üì° –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥: {status}\n"
    )
    return message


================================================================================
–§–ê–ô–õ: telegram_bot/utils/validators.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/telegram_bot/utils/validators.py
================================================================================

"""
–í–∞–ª–∏–¥–∞—Ü–∏—è –≤–≤–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
"""

def validate_ticker(ticker: str) -> bool:
    """
    –ü—Ä–æ—Å—Ç–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ç–∏–∫–µ—Ä–∞: —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã, –¥–ª–∏–Ω–∞ 2-10
    """
    if not ticker:
        return False
    if len(ticker) < 2 or len(ticker) > 10:
        return False
    if not ticker.isalnum():
        return False
    return True

def validate_depth(depth: int) -> bool:
    """
    –ì–ª—É–±–∏–Ω–∞ —Å—Ç–∞–∫–∞–Ω–∞: –æ—Ç 1 –¥–æ 50
    """
    return 1 <= depth <= 50

def validate_interval(interval: int) -> bool:
    """
    –ò–Ω—Ç–µ—Ä–≤–∞–ª –æ—Ç–ø—Ä–∞–≤–∫–∏: –æ—Ç 1 –¥–æ 3600 —Å–µ–∫—É–Ω–¥
    """
    return 1 <= interval <= 3600


================================================================================
–§–ê–ô–õ: tests/__init__.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/tests/__init__.py
================================================================================



================================================================================
–§–ê–ô–õ: tests/final_structure_test.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/tests/final_structure_test.py
================================================================================

import sys
import os

# –î–æ–±–∞–≤–ª—è–µ–º src –≤ –ø—É—Ç—å Python
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..'))

def test_imports():
    """–¢–µ—Å—Ç–∏—Ä—É–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—à–∏ –º–æ–¥—É–ª–∏"""
    print("üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º –∏–º–ø–æ—Ä—Ç—ã...")
    
    try:
        from src.utils.logger import log
        print("‚úÖ src.utils.logger - –û–ö")
    except ImportError as e:
        print(f"‚ùå src.utils.logger: {e}")
    
    try:
        from src.data_feed.moex_client import MOEXClient
        print("‚úÖ src.data_feed.moex_client - –û–ö")
    except ImportError as e:
        print(f"‚ùå src.data_feed.moex_client: {e}")
    
    try:
        import pandas as pd
        print("‚úÖ pandas - –û–ö")
    except ImportError as e:
        print(f"‚ùå pandas: {e}")
    
    print("\nüéØ –¢–µ—Å—Ç –∏–º–ø–æ—Ä—Ç–æ–≤ –∑–∞–≤–µ—Ä—à—ë–Ω")

if __name__ == "__main__":
    test_imports()


================================================================================
–§–ê–ô–õ: tests/test_basic.py
–ü–û–õ–ù–´–ô –ü–£–¢–¨: /Users/vladimirbasov/Desktop/python_trading/tests/test_basic.py
================================================================================

# test_basic.py
import pandas as pd
import numpy as np
import requests
import ccxt

print("‚úÖ –í—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç!")

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ
data = pd.DataFrame({
    'price': [100, 101, 102, 101, 103],
    'volume': [1000, 1500, 1200, 1800, 2000]
})

print("üìä –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ:")
print(data)
print(f"üìà –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞: {data['price'].mean():.2f}")

# –ü—Ä–æ–≤–µ—Ä—è–µ–º requests
response = requests.get('https://httpbin.org/json')
print(f"üåê HTTP –∑–∞–ø—Ä–æ—Å: {response.status_code}")

================================================================================
üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –≠–ö–°–ü–û–†–¢–ê
================================================================================
–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤: 61
–û–±—â–∏–π —Ä–∞–∑–º–µ—Ä –∫–æ–¥–∞: 129506 –±–∞–π—Ç (126.5 –ö–ë)
–î–∞—Ç–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: 2025-12-11 21:58:01
================================================================================

üéØ –ò–ù–°–¢–†–£–ö–¶–ò–Ø –î–õ–Ø –ê–ù–ê–õ–ò–ó–ê:
1. –ò—â–∏—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ñ–∞–π–ª—ã –ø–æ —Å—Ç—Ä–æ–∫–µ "–§–ê–ô–õ: "
2. –í—Å–µ –ø—É—Ç–∏ —É–∫–∞–∑–∞–Ω—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ: /Users/vladimirbasov/Desktop/python_trading
3. –î–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
4. .env —Ñ–∞–π–ª—ã –æ—á–∏—â–µ–Ω—ã –æ—Ç —Å–µ–∫—Ä–µ—Ç–æ–≤

================================================================================
–ö–û–ù–ï–¶ –≠–ö–°–ü–û–†–¢–ê
================================================================================
